<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>PharmDigits — Gao Lab Inventory</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500;700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>

<!-- ══════════════════════════════════════════════════
     FIREBASE CONFIG — Replace the 5 values below with
     your own from Firebase Console > Project Settings
     ══════════════════════════════════════════════════ -->
<script type="module">
import { initializeApp }           from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword,
         signOut, onAuthStateChanged }
                                   from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
import { getFirestore, collection, doc, getDocs, getDoc,
         setDoc, addDoc, updateDoc, deleteDoc,
         onSnapshot, serverTimestamp, query, orderBy }
                                   from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

// ── FIREBASE CONFIG — Gao Lab Inventory ───────────────
const firebaseConfig = {
  apiKey:            "AIzaSyAm1blb77kMRvQLBf73NSY0iUn_a3EgGys",
  authDomain:        "gao-lab-inventory.firebaseapp.com",
  projectId:         "gao-lab-inventory",
  storageBucket:     "gao-lab-inventory.firebasestorage.app",
  messagingSenderId: "289329337116",
  appId:             "1:289329337116:web:586de3abf669fee1f860d9",
  measurementId:     "G-8LDTQM2Y3Y"
};
// ──────────────────────────────────────────────────────

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getFirestore(app);

// Expose to global scope so non-module scripts can use them
window.__fb = { auth, db, signInWithEmailAndPassword, createUserWithEmailAndPassword,
  signOut, onAuthStateChanged, collection, doc, getDocs, getDoc,
  setDoc, addDoc, updateDoc, deleteDoc, onSnapshot, serverTimestamp, query, orderBy };
</script>

<style>
:root {
  --bg:#f0f4f8; --surface:#ffffff; --surface2:#f7f9fc; --surface3:#edf1f7;
  --border:#dde3ee; --border2:#c8d0e0;
  --accent:#0077cc; --accent2:#6d28d9;
  --green:#16a34a; --yellow:#d97706; --red:#dc2626; --orange:#ea580c;
  --text:#1a202c; --text2:#4a5568; --text3:#9aa5b4;
  --mono:'JetBrains Mono',monospace; --sans:'Syne',sans-serif;
}
*{box-sizing:border-box;margin:0;padding:0;}
body{font-family:var(--sans);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;font-size:15px;}
::-webkit-scrollbar{width:4px;height:4px;}
::-webkit-scrollbar-track{background:var(--surface);}
::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}

/* ── LOGIN SCREEN ── */
.login-screen{position:fixed;inset:0;background:linear-gradient(135deg,#0f172a 0%,#1e3a5f 50%,#0f172a 100%);display:flex;align-items:center;justify-content:center;z-index:9999;}
.login-box{background:rgba(255,255,255,0.06);backdrop-filter:blur(20px);border:1px solid rgba(255,255,255,0.12);border-radius:20px;padding:48px 44px;width:400px;box-shadow:0 32px 80px rgba(0,0,0,0.4);}
.login-logo{font-family:var(--sans);font-size:30px;font-weight:800;color:#fff;margin-bottom:6px;}
.login-logo span{color:#38bdf8;}
.login-sub{font-family:var(--mono);font-size:12px;color:rgba(255,255,255,0.45);margin-bottom:36px;letter-spacing:1px;}
.login-field{margin-bottom:16px;}
.login-field label{display:block;font-family:var(--mono);font-size:11px;color:rgba(255,255,255,0.5);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
.login-field input{width:100%;background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:12px 14px;color:#fff;font-family:var(--mono);font-size:14px;outline:none;transition:border-color 0.2s;}
.login-field input:focus{border-color:#38bdf8;background:rgba(56,189,248,0.08);}
.login-field input::placeholder{color:rgba(255,255,255,0.25);}
.login-btn{width:100%;background:linear-gradient(135deg,#0077cc,#0ea5e9);border:none;border-radius:10px;padding:13px;color:#fff;font-family:var(--sans);font-size:15px;font-weight:700;cursor:pointer;margin-top:8px;transition:all 0.2s;letter-spacing:0.3px;}
.login-btn:hover{filter:brightness(1.1);transform:translateY(-1px);}
.login-btn:disabled{opacity:0.5;cursor:not-allowed;transform:none;}
.login-err{background:rgba(220,38,38,0.15);border:1px solid rgba(220,38,38,0.3);color:#fca5a5;font-family:var(--mono);font-size:11px;padding:10px 14px;border-radius:8px;margin-top:12px;display:none;}
.login-err.show{display:block;}
.login-divider{text-align:center;font-family:var(--mono);font-size:10px;color:rgba(255,255,255,0.25);margin:20px 0;letter-spacing:1px;}
.login-register-btn{width:100%;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:11px;color:rgba(255,255,255,0.7);font-family:var(--sans);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.2s;}
.login-register-btn:hover{background:rgba(255,255,255,0.1);color:#fff;}
.login-spinner{display:inline-block;width:14px;height:14px;border:2px solid rgba(255,255,255,0.3);border-top-color:#fff;border-radius:50%;animation:spin 0.7s linear infinite;vertical-align:middle;margin-right:6px;}
@keyframes spin{to{transform:rotate(360deg)}}

/* ── SYNC INDICATOR ── */
.sync-dot{width:8px;height:8px;border-radius:50%;background:var(--green);display:inline-block;margin-right:4px;}
.sync-dot.syncing{background:var(--yellow);animation:pulse 1s infinite;}
.sync-dot.offline{background:var(--red);}

/* HEADER */
header{display:flex;align-items:center;justify-content:space-between;padding:0 28px;height:58px;background:var(--surface);border-bottom:1px solid var(--border);position:sticky;top:0;z-index:100;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.logo{font-size:20px;font-weight:800;letter-spacing:-0.5px;color:var(--text);}
.logo span{color:var(--accent);}
.header-center{font-family:var(--mono);font-size:11px;color:var(--text2);display:flex;align-items:center;gap:6px;}
.header-right{display:flex;align-items:center;gap:10px;}
.user-pill{display:flex;align-items:center;gap:7px;background:var(--surface2);border:1px solid var(--border);padding:5px 14px;border-radius:20px;cursor:pointer;font-size:13px;font-family:var(--mono);}
.role-badge{font-size:11px;padding:2px 6px;border-radius:4px;color:#fff;font-weight:700;}
.role-badge.manager{background:#0077cc;}
.role-badge.user{background:#9aa5b4;}
.notif-btn{position:relative;background:var(--surface2);border:1px solid var(--border);width:34px;height:34px;border-radius:8px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:16px;}
.notif-count{position:absolute;top:-4px;right:-4px;background:var(--red);color:#fff;font-size:9px;width:16px;height:16px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-family:var(--mono);font-weight:700;}

/* LAYOUT */
.app{display:flex;height:calc(100vh - 58px);}
.sidebar{width:220px;flex-shrink:0;background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;padding:12px 0;overflow-y:auto;box-shadow:2px 0 8px rgba(0,0,0,0.04);}
.nav-item{display:flex;align-items:center;gap:10px;padding:10px 18px;cursor:pointer;font-size:13px;font-weight:600;color:var(--text2);transition:all 0.15s;border-left:3px solid transparent;user-select:none;}
.nav-item:hover{color:var(--text);background:var(--surface2);}
.nav-item.active{color:var(--accent);background:rgba(0,119,204,0.07);border-left-color:var(--accent);}
.nav-icon{font-style:normal;font-size:15px;width:20px;text-align:center;flex-shrink:0;}
.nav-section{font-size:11px;font-family:var(--mono);color:var(--text3);padding:10px 18px 3px;letter-spacing:1.5px;text-transform:uppercase;}
.nav-divider{border-top:1px solid var(--border);margin:6px 0;}

.main{flex:1;overflow-y:auto;padding:24px 28px;}
.page{display:none;}
.page.active{display:block;}
.page-title{font-size:24px;font-weight:800;margin-bottom:4px;}
.page-sub{color:var(--text3);font-size:13px;font-family:var(--mono);margin-bottom:20px;}

/* STATS */
.stats-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
.stat-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.stat-card .slabel{font-size:11px;font-family:var(--mono);color:var(--text3);letter-spacing:1px;text-transform:uppercase;margin-bottom:7px;}
.stat-card .svalue{font-size:32px;font-weight:800;line-height:1;}
.stat-card .sdelta{font-size:12px;font-family:var(--mono);margin-top:5px;color:var(--text2);}
.stat-card.warn .svalue{color:var(--red);}
.stat-card.ok .svalue{color:var(--green);}
.stat-card.info .svalue{color:var(--accent);}
.stat-card.caution .svalue{color:var(--yellow);}
.stat-card.purple .svalue{color:var(--accent2);}

/* TOOLBAR */
.toolbar{display:flex;align-items:center;gap:10px;margin-bottom:16px;flex-wrap:wrap;}
.search-box{flex:1;min-width:180px;display:flex;align-items:center;gap:8px;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:0 12px;height:36px;box-shadow:0 1px 4px rgba(0,0,0,0.05);}
.search-box input{flex:1;background:none;border:none;outline:none;color:var(--text);font-family:var(--mono);font-size:13px;}
.search-box input::placeholder{color:var(--text3);}
select,.btn{height:38px;border-radius:8px;font-family:var(--sans);font-size:13px;font-weight:600;cursor:pointer;transition:all 0.15s;}
select{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:0 10px;outline:none;}
.btn{display:flex;align-items:center;gap:5px;padding:0 14px;border:1px solid var(--border);background:var(--surface);color:var(--text);white-space:nowrap;}
.btn:hover{background:var(--surface3);border-color:var(--border2);}
.btn.primary{background:var(--accent);color:#fff;border-color:var(--accent);}
.btn.primary:hover{filter:brightness(1.1);}
.btn.danger{background:rgba(220,38,38,0.08);color:var(--red);border-color:var(--red);}
.btn.sm{height:30px;padding:0 10px;font-size:12px;}

/* VIEW TOGGLE */
.cat-view-toggle{display:flex;gap:6px;margin-bottom:16px;align-items:center;}
.view-btn{display:flex;align-items:center;gap:5px;padding:5px 12px;border-radius:8px;border:1px solid var(--border);background:var(--surface);cursor:pointer;font-size:11px;font-weight:600;color:var(--text2);transition:all 0.15s;}
.view-btn.active{background:var(--accent);color:#fff;border-color:var(--accent);}

/* CATEGORY VIEW */
.category-section{margin-bottom:24px;}
.category-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;background:var(--surface2);border:1px solid var(--border);border-radius:10px 10px 0 0;cursor:pointer;user-select:none;}
.category-header:hover{background:var(--surface3);}
.cat-header-left{display:flex;align-items:center;gap:8px;}
.cat-title{font-size:13px;font-weight:700;}
.cat-count{font-size:12px;font-family:var(--mono);color:var(--text2);background:var(--surface);border:1px solid var(--border);padding:2px 7px;border-radius:10px;}
.cat-toggle-icon{font-size:11px;color:var(--text3);transition:transform 0.2s;}
.cat-toggle-icon.open{transform:rotate(180deg);}
.cat-body{border:1px solid var(--border);border-top:none;border-radius:0 0 10px 10px;overflow:hidden;}
.cat-sort-bar{display:flex;align-items:center;gap:6px;padding:7px 14px;background:var(--surface);border-bottom:1px solid var(--border);flex-wrap:wrap;}
.cat-sort-bar span{font-size:9px;font-family:var(--mono);color:var(--text3);text-transform:uppercase;letter-spacing:1px;}
.sort-chip{font-size:10px;font-family:var(--mono);padding:2px 7px;border-radius:4px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;color:var(--text2);transition:all 0.12s;}
.sort-chip.active{background:var(--accent);color:#fff;border-color:var(--accent);}

/* TABLE */
.table-wrap{background:var(--surface);border:1px solid var(--border);border-radius:12px;overflow:hidden;box-shadow:0 2px 12px rgba(0,0,0,0.06);overflow-x:auto;}
table{width:100%;border-collapse:collapse;font-size:14px;min-width:700px;}
thead th{background:var(--surface2);padding:9px 10px;text-align:left;font-family:var(--mono);font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--text3);border-bottom:1px solid var(--border);white-space:nowrap;}
tbody tr{border-bottom:1px solid var(--border);transition:background 0.1s;}
tbody tr:last-child{border-bottom:none;}
tbody tr:hover{background:var(--surface2);}
tbody td{padding:9px 10px;vertical-align:middle;}
.item-name{font-weight:700;color:var(--text);font-size:15px;}
.item-cat{display:inline-block;font-size:11px;font-family:var(--mono);padding:2px 7px;border-radius:4px;font-weight:700;}
.cat-antibody{background:rgba(109,40,217,0.1);color:#6d28d9;border:1px solid rgba(109,40,217,0.25);}
.cat-chemical{background:rgba(220,38,38,0.1);color:#b91c1c;border:1px solid rgba(220,38,38,0.25);}
.cat-buffer{background:rgba(8,145,178,0.1);color:#0e7490;border:1px solid rgba(8,145,178,0.25);}
.cat-enzyme{background:rgba(234,88,12,0.1);color:#c2410c;border:1px solid rgba(234,88,12,0.25);}
.cat-cellculture{background:rgba(22,163,74,0.1);color:#15803d;border:1px solid rgba(22,163,74,0.25);}
.cat-kit{background:rgba(0,119,204,0.1);color:#0055aa;border:1px solid rgba(0,119,204,0.25);}
.cat-primer{background:rgba(217,119,6,0.1);color:#92400e;border:1px solid rgba(217,119,6,0.25);}
.cat-plasmid{background:rgba(219,39,119,0.1);color:#be185d;border:1px solid rgba(219,39,119,0.25);}
.cat-supplies{background:rgba(107,114,128,0.1);color:#374151;border:1px solid rgba(107,114,128,0.25);}
.cat-other{background:rgba(79,70,229,0.1);color:#3730a3;border:1px solid rgba(79,70,229,0.25);}
.vendor-badge{display:inline-block;font-size:11px;font-family:var(--mono);padding:2px 6px;border-radius:4px;font-weight:600;background:rgba(0,119,204,0.07);color:var(--accent);border:1px solid rgba(0,119,204,0.18);}
.cat-num{font-size:12px;font-family:var(--mono);color:var(--text3);}
.temp-badge{display:inline-block;font-size:11px;font-family:var(--mono);padding:2px 6px;border-radius:4px;background:rgba(8,145,178,0.08);color:#0e7490;border:1px solid rgba(8,145,178,0.2);}
.qty-cell{font-family:var(--mono);font-weight:700;font-size:14px;}
.qty-cell.low{color:var(--red);}
.qty-cell.medium{color:var(--yellow);}
.qty-cell.ok{color:var(--green);}
.low-badge{font-size:11px;font-family:var(--mono);padding:2px 5px;border-radius:3px;background:rgba(220,38,38,0.1);color:var(--red);border:1px solid rgba(220,38,38,0.25);margin-left:3px;animation:pulse 2s infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
.hazard-badge{font-size:11px;font-family:var(--mono);padding:2px 5px;border-radius:3px;background:rgba(234,88,12,0.1);color:var(--orange);border:1px solid rgba(234,88,12,0.25);}
.sds-link{color:var(--accent);font-size:10px;font-family:var(--mono);text-decoration:none;}
.sds-link:hover{text-decoration:underline;}
.actions{display:flex;gap:4px;align-items:center;}
.icon-btn{width:34px;height:34px;border-radius:7px;border:1px solid var(--border);background:var(--surface2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:600;transition:all 0.15s;flex-shrink:0;}
.icon-btn:hover{background:var(--surface3);border-color:var(--border2);}
.icon-btn.del:hover{background:rgba(220,38,38,0.08);border-color:var(--red);}

/* ITEM THUMBNAIL */
.item-thumb{width:32px;height:32px;border-radius:6px;object-fit:cover;border:1px solid var(--border);cursor:pointer;}
.item-thumb-placeholder{width:32px;height:32px;border-radius:6px;border:1px dashed var(--border2);display:flex;align-items:center;justify-content:center;font-size:12px;color:var(--text3);cursor:pointer;}

/* ORDER STATUS BADGES */
.order-status-badge{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-family:var(--mono);font-weight:700;padding:2px 6px;border-radius:4px;cursor:pointer;white-space:nowrap;transition:all 0.15s;border:1px solid;user-select:none;}
.order-status-badge:hover{filter:brightness(0.9);}
.osb-none{background:rgba(155,155,155,0.1);color:#888;border-color:#ccc;}
.osb-notice{background:rgba(217,119,6,0.12);color:#a05a00;border-color:rgba(217,119,6,0.4);}
.osb-inprogress{background:rgba(109,40,217,0.12);color:#5b21b6;border-color:rgba(109,40,217,0.4);}
.osb-approved{background:rgba(0,119,204,0.12);color:#005fa3;border-color:rgba(0,119,204,0.4);}
.osb-shipped{background:rgba(8,145,178,0.12);color:#0e7490;border-color:rgba(8,145,178,0.4);}
.osb-delivered{background:rgba(22,163,74,0.12);color:#15803d;border-color:rgba(22,163,74,0.4);}
.osb-backordered{background:rgba(220,38,38,0.12);color:#b91c1c;border-color:rgba(220,38,38,0.4);}

/* STATUS POPUP */
.status-popup-wrap{position:relative;display:inline-flex;}
/* dropdown now renders in a fixed overlay so table rows never clip it */
#statusOverlay{position:fixed;z-index:9000;pointer-events:none;}
#statusOverlay.active{pointer-events:all;}
.status-dropdown{position:fixed;z-index:9001;background:var(--surface);border:1px solid var(--border2);border-radius:10px;box-shadow:0 8px 32px rgba(0,0,0,0.18);padding:5px;min-width:215px;animation:dropIn 0.15s ease;}
@keyframes dropIn{from{opacity:0;transform:translateY(-5px)}to{opacity:1;transform:translateY(0)}}
.status-dropdown-title{font-size:9px;font-family:var(--mono);color:var(--text3);text-transform:uppercase;letter-spacing:1px;padding:4px 8px 5px;border-bottom:1px solid var(--border);margin-bottom:3px;}
.status-option{display:flex;align-items:center;gap:7px;padding:6px 9px;border-radius:6px;cursor:pointer;font-size:11px;font-family:var(--mono);transition:background 0.1s;}
.status-option:hover{background:var(--surface2);}
.so-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.so-label{font-weight:600;flex:1;}
.so-check{color:var(--green);font-size:10px;}
.status-note-row{padding:6px 8px 3px;border-top:1px solid var(--border);margin-top:3px;}
.status-note-row label{font-size:9px;font-family:var(--mono);color:var(--text3);text-transform:uppercase;letter-spacing:1px;display:block;margin-bottom:3px;}
.status-note-row input{width:100%;background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:4px 7px;font-family:var(--mono);font-size:11px;color:var(--text);outline:none;}

/* ORDER TRACKER */
.order-filter-row{display:flex;gap:7px;margin-bottom:18px;flex-wrap:wrap;align-items:center;}
.filter-chip{font-size:10px;font-family:var(--mono);padding:4px 11px;border-radius:20px;border:1px solid var(--border);background:var(--surface);cursor:pointer;color:var(--text2);transition:all 0.15s;font-weight:600;}
.filter-chip.active{background:var(--accent);color:#fff;border-color:var(--accent);}
.order-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px 18px;margin-bottom:10px;box-shadow:0 2px 8px rgba(0,0,0,0.04);display:flex;align-items:flex-start;gap:14px;}
.order-card:hover{box-shadow:0 4px 16px rgba(0,0,0,0.09);}
.order-card-left{flex:1;min-width:0;}
.order-card-name{font-size:14px;font-weight:700;margin-bottom:4px;}
.order-card-meta{font-size:10px;font-family:var(--mono);color:var(--text2);display:flex;gap:10px;flex-wrap:wrap;margin-bottom:6px;}
.order-card-note{font-size:11px;font-family:var(--mono);color:var(--text2);background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:5px 9px;margin-top:5px;}
.order-card-right{display:flex;flex-direction:column;align-items:flex-end;gap:7px;flex-shrink:0;}
.timeline{margin-top:8px;}
.timeline-item{display:flex;gap:9px;align-items:flex-start;}
.timeline-dot{width:7px;height:7px;border-radius:50%;flex-shrink:0;margin-top:4px;}
.timeline-connector{width:2px;background:var(--border);min-height:10px;margin-left:3px;}
.timeline-content{padding-bottom:8px;font-size:10px;font-family:var(--mono);color:var(--text2);}
.timeline-content strong{color:var(--text);}

/* MODAL */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.35);display:none;align-items:center;justify-content:center;z-index:200;backdrop-filter:blur(4px);}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);border-radius:16px;width:660px;max-height:90vh;overflow-y:auto;box-shadow:0 24px 60px rgba(0,0,0,0.15);animation:modalIn 0.2s ease;}
.modal.sm{width:420px;}
.modal.lg{width:780px;}
@keyframes modalIn{from{opacity:0;transform:translateY(-14px)}to{opacity:1;transform:translateY(0)}}
.modal-header{padding:22px 26px 0;display:flex;align-items:center;justify-content:space-between;}
.modal-title{font-size:19px;font-weight:800;}
.modal-close{font-size:18px;cursor:pointer;color:var(--text3);background:none;border:none;}
.modal-close:hover{color:var(--text);}
.modal-body{padding:18px 26px 26px;}
.form-section-label{font-size:11px;font-family:var(--mono);color:var(--text3);letter-spacing:1.5px;text-transform:uppercase;padding:12px 0 7px;border-bottom:1px solid var(--border);margin-bottom:12px;}
.form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}
.form-grid.full{grid-template-columns:1fr;}
.field{display:flex;flex-direction:column;gap:5px;}
.field label{font-size:11px;font-family:var(--mono);color:var(--text2);letter-spacing:0.8px;text-transform:uppercase;}
.field input,.field select,.field textarea{background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 11px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;transition:border-color 0.15s;}
.field input:focus,.field select:focus,.field textarea:focus{border-color:var(--accent);box-shadow:0 0 0 3px rgba(0,119,204,0.1);}
.field textarea{resize:vertical;min-height:60px;}
.field .cat-suggest{font-size:10px;color:var(--accent);font-family:var(--mono);cursor:pointer;padding:3px 7px;background:rgba(0,119,204,0.08);border-radius:4px;display:inline-block;border:1px solid rgba(0,119,204,0.2);margin-top:3px;}
.modal-footer{display:flex;justify-content:flex-end;gap:9px;margin-top:18px;}

/* IMAGE UPLOAD */
.img-upload-area{border:2px dashed var(--border2);border-radius:10px;padding:20px;text-align:center;cursor:pointer;transition:all 0.15s;background:var(--surface2);}
.img-upload-area:hover{border-color:var(--accent);background:rgba(0,119,204,0.04);}
.img-preview{position:relative;display:inline-block;}
.img-preview img{width:120px;height:120px;object-fit:cover;border-radius:10px;border:2px solid var(--border);display:block;}
.img-preview .remove-img{position:absolute;top:-6px;right:-6px;width:20px;height:20px;border-radius:50%;background:var(--red);color:#fff;display:flex;align-items:center;justify-content:center;font-size:11px;cursor:pointer;border:2px solid var(--surface);}

/* LIGHTBOX */
.lightbox{position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:999;display:none;align-items:center;justify-content:center;cursor:pointer;}
.lightbox.open{display:flex;}
.lightbox img{max-width:90vw;max-height:90vh;border-radius:12px;}
.lightbox-close{position:absolute;top:20px;right:24px;color:#fff;font-size:28px;cursor:pointer;}

/* NOTIFICATIONS */
.notif-panel{position:fixed;top:58px;right:0;width:320px;height:calc(100vh - 58px);background:var(--surface);border-left:1px solid var(--border);z-index:150;transform:translateX(100%);transition:transform 0.25s ease;overflow-y:auto;padding:18px;box-shadow:-4px 0 20px rgba(0,0,0,0.08);}
.notif-panel.open{transform:translateX(0);}
.notif-title{font-size:15px;font-weight:700;margin-bottom:14px;}
.notif-item{padding:10px;border-radius:8px;margin-bottom:9px;border-left:3px solid;font-size:13px;font-family:var(--mono);}
.notif-item.danger{background:rgba(220,38,38,0.06);border-color:var(--red);}
.notif-item.warning{background:rgba(217,119,6,0.06);border-color:var(--yellow);}
.notif-item .n-title{font-weight:700;margin-bottom:2px;}
.notif-item .n-sub{color:var(--text2);}

/* ANALYTICS */
.analytics-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px;}
.chart-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.chart-card h3{font-size:11px;font-family:var(--mono);color:var(--text2);margin-bottom:14px;text-transform:uppercase;letter-spacing:0.8px;}
.bar-chart{display:flex;flex-direction:column;gap:7px;}
.bar-row{display:flex;align-items:center;gap:9px;}
.bar-label{font-size:12px;font-family:var(--mono);width:90px;flex-shrink:0;color:var(--text2);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.bar-track{flex:1;height:18px;background:var(--surface2);border-radius:4px;overflow:hidden;border:1px solid var(--border);}
.bar-fill{height:100%;border-radius:4px;transition:width 0.6s ease;display:flex;align-items:center;padding-left:5px;}
.bar-fill span{font-size:9px;font-family:var(--mono);color:#fff;font-weight:700;}
.history-table{font-size:12px;font-family:var(--mono);}
.h-row{display:flex;justify-content:space-between;padding:7px 0;border-bottom:1px solid var(--border);gap:7px;}
.h-row:last-child{border-bottom:none;}
.h-action{color:var(--accent);flex-shrink:0;}
.h-time{color:var(--text3);font-size:9px;flex-shrink:0;}

/* EMAIL */
.email-config-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:20px;box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:18px;}
.email-config-card h3{font-size:13px;font-weight:700;margin-bottom:14px;}
.email-row{display:flex;align-items:center;gap:11px;padding:9px 0;border-bottom:1px solid var(--border);}
.email-row:last-child{border-bottom:none;}
.email-row .er-label{flex:1;font-size:12px;font-weight:600;}
.email-row .er-sub{font-size:10px;font-family:var(--mono);color:var(--text2);margin-top:2px;}
.toggle-switch{position:relative;width:38px;height:21px;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;}
.toggle-slider{position:absolute;inset:0;background:var(--border2);border-radius:11px;cursor:pointer;transition:0.2s;}
.toggle-slider:before{content:'';position:absolute;width:15px;height:15px;left:3px;top:3px;background:white;border-radius:50%;transition:0.2s;}
input:checked+.toggle-slider{background:var(--accent);}
input:checked+.toggle-slider:before{transform:translateX(17px);}
.emailjs-setup{background:linear-gradient(135deg,rgba(0,119,204,0.06),rgba(109,40,217,0.06));border:1px solid rgba(0,119,204,0.2);border-radius:12px;padding:18px;margin-bottom:18px;}
.emailjs-setup h3{font-size:13px;font-weight:700;margin-bottom:11px;color:var(--accent);}

/* BARCODE */
.barcode-area{background:var(--surface2);border:2px dashed var(--border2);border-radius:12px;padding:36px;text-align:center;margin-bottom:18px;}
.barcode-text{color:var(--text2);font-size:12px;margin-bottom:14px;}
.barcode-input-wrap{display:flex;gap:9px;}
.barcode-input-wrap input{flex:1;background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:9px 12px;color:var(--text);font-family:var(--mono);font-size:13px;outline:none;letter-spacing:2px;}
.barcode-input-wrap input:focus{border-color:var(--accent);}
.scan-result{background:var(--surface);border:1px solid var(--border);border-radius:8px;padding:14px;font-family:var(--mono);font-size:12px;}
.sr-label{font-size:11px;color:var(--text3);margin-bottom:3px;letter-spacing:1px;text-transform:uppercase;}
.sr-name{font-size:15px;font-weight:700;margin-bottom:7px;}
.sr-row{display:flex;justify-content:space-between;color:var(--text2);font-size:13px;padding:5px 0;border-bottom:1px solid var(--border);}
.sr-row:last-child{border-bottom:none;}

/* USERS */
.user-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px;}
.user-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:18px;box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.u-name{font-size:15px;font-weight:700;margin-bottom:3px;}
.u-email{font-size:10px;font-family:var(--mono);color:var(--text2);margin-bottom:9px;}

/* ALERTS */
.alert-item-row{display:flex;align-items:center;gap:10px;padding:9px 11px;background:var(--surface2);border:1px solid var(--border);border-radius:8px;margin-bottom:7px;font-family:var(--mono);font-size:11px;}
.ai-name{flex:1;font-weight:600;color:var(--text);}

/* MISC */
.empty{text-align:center;padding:50px;color:var(--text3);font-size:13px;}
.e-icon{font-size:38px;margin-bottom:10px;}
.loading-spinner{display:flex;align-items:center;justify-content:center;padding:60px;flex-direction:column;gap:14px;color:var(--text3);font-family:var(--mono);font-size:12px;}
.spinner{width:32px;height:32px;border:3px solid var(--border2);border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;}
.toast-container{position:fixed;bottom:22px;right:22px;z-index:600;display:flex;flex-direction:column;gap:9px;}
.toast{padding:11px 16px;border-radius:10px;font-size:13px;font-family:var(--mono);background:var(--surface);border:1px solid var(--border);box-shadow:0 8px 24px rgba(0,0,0,0.12);animation:toastIn 0.3s ease;display:flex;align-items:center;gap:9px;}
@keyframes toastIn{from{opacity:0;transform:translateY(18px)}to{opacity:1;transform:translateY(0)}}
.toast.success{border-left:4px solid var(--green);}
.toast.error{border-left:4px solid var(--red);}
.toast.warning{border-left:4px solid var(--yellow);}
.toast.info{border-left:4px solid var(--accent);}
.lab-settings-card{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:24px;max-width:580px;box-shadow:0 2px 8px rgba(0,0,0,0.05);margin-bottom:18px;}
.lab-settings-card h3{font-size:13px;font-weight:700;margin-bottom:16px;color:var(--text);}
.color-swatches{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px;}
.color-swatch{width:32px;height:32px;border-radius:8px;cursor:pointer;border:3px solid transparent;transition:all 0.15s;}
.color-swatch.active{border-color:var(--text);transform:scale(1.1);}
.preview-bar{height:6px;border-radius:3px;margin-top:10px;transition:background 0.3s;}
</style>
</head>
<body>

<!-- ══ LOGIN SCREEN ══════════════════════════════════ -->
<div class="login-screen" id="loginScreen">
  <div class="login-box">
    <div class="login-logo">Pharm<span>Digits</span></div>
    <div class="login-sub" id="loginSubtitle">GAO LAB INVENTORY SYSTEM</div>
    <div class="login-field">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="you@lab.edu" autocomplete="email">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="loginPass" placeholder="••••••••" autocomplete="current-password" onkeydown="if(event.key==='Enter')doLogin()">
    </div>
    <button class="login-btn" id="loginBtn" onclick="doLogin()">Sign In</button>
    <div class="login-err" id="loginErr"></div>
    <div class="login-divider">— NEW MEMBER —</div>
    <button class="login-register-btn" onclick="showRegisterPanel()">Create Account</button>

    <!-- Register panel (hidden by default) -->
    <div id="registerPanel" style="display:none;margin-top:20px;border-top:1px solid rgba(255,255,255,0.1);padding-top:20px;">
      <div class="login-field">
        <label>Full Name</label>
        <input type="text" id="regName" placeholder="Dr. Smith">
      </div>
      <div class="login-field">
        <label>Email</label>
        <input type="email" id="regEmail" placeholder="you@lab.edu">
      </div>
      <div class="login-field">
        <label>Password (min 6 chars)</label>
        <input type="password" id="regPass" placeholder="••••••••">
      </div>
      <button class="login-btn" onclick="doRegister()" style="background:linear-gradient(135deg,#16a34a,#22c55e);">Create Account</button>
      <div class="login-err" id="regErr"></div>
    </div>
  </div>
</div>

<!-- ══ MAIN APP ══════════════════════════════════════ -->
<header id="appHeader" style="display:none">
  <div class="logo" id="appLogo">Pharm<span>Digits</span> <span style="font-size:12px;font-weight:400;color:var(--text3);font-family:var(--mono)" id="headerLabName">— Gao Lab</span></div>
  <div class="header-center">
    <span class="sync-dot" id="syncDot"></span>
    <span id="syncLabel">Connected</span>
  </div>
  <div class="header-right">
    <div class="notif-btn" onclick="toggleNotifPanel()">&#128276;<div class="notif-count" id="notifCount">0</div></div>
    <div class="user-pill" onclick="doSignOut()">
      <span id="currentUserName">User</span>
      <span class="role-badge manager" id="currentRoleBadge">MANAGER</span>
      <span style="color:var(--text3);font-size:10px">&#x2715; Sign Out</span>
    </div>
  </div>
</header>

<div class="app" id="appBody" style="display:none">
  <div class="sidebar" id="sidebar"></div>
  <div class="main">

    <div class="page active" id="page-inventory">
      <div class="page-title">Inventory</div>
      <div class="page-sub" id="inventoryPageSub">// Gao Lab — all items</div>
      <div class="stats-row" id="statsRow"></div>
      <div class="toolbar">
        <button class="btn primary" id="addItemBtn" onclick="openAddModal()">+ Add Item</button>
        <div class="search-box" style="flex:1">
          <span>&#128269;</span>
          <input type="text" id="searchInput" placeholder="Search name, vendor, Cat#, CAS#, location..." oninput="renderInventory()">
        </div>
        <select id="filterSort" onchange="renderInventory()">
          <option value="alpha">A to Z</option>
          <option value="alpha-desc">Z to A</option>
          <option value="qty-asc">Qty: Low to High</option>
          <option value="qty-desc">Qty: High to Low</option>
          <option value="expiry">Expiry Soon</option>
          <option value="vendor">Vendor</option>
          <option value="location">Location</option>
        </select>
        <button class="btn" onclick="exportCSV()">&#11015; Export CSV</button>
      </div>
      <div class="cat-view-toggle">
        <span style="font-size:11px;font-family:var(--mono);color:var(--text3);margin-right:3px">VIEW:</span>
        <div class="view-btn active" id="viewFlat" onclick="setViewMode('flat')">&#9776; Flat List</div>
        <div class="view-btn" id="viewCat" onclick="setViewMode('category')">&#8862; By Category</div>
      </div>
      <div id="inventoryContent"><div class="loading-spinner"><div class="spinner"></div>Loading from Firestore...</div></div>
    </div>

    <div class="page" id="page-orders">
      <div class="page-title">Order Tracker</div>
      <div class="page-sub">// reorder status for low-stock items</div>
      <div id="orderTrackerContent"></div>
    </div>

    <div class="page" id="page-analytics">
      <div class="page-title">Analytics</div>
      <div class="page-sub">// usage trends and reporting</div>
      <div class="analytics-grid" id="analyticsContent"></div>
    </div>

    <div class="page" id="page-scan">
      <div class="page-title">Barcode Scan</div>
      <div class="page-sub">// scan or type barcode to look up item</div>
      <div class="barcode-area">
        <div style="font-size:44px;margin-bottom:10px;">&#9638;</div>
        <div class="barcode-text">Scan a barcode with your scanner, or type it below</div>
        <div class="barcode-input-wrap">
          <input type="text" id="barcodeInput" placeholder="e.g. PD-00001" onkeydown="if(event.key==='Enter')scanBarcode()">
          <button class="btn primary" onclick="scanBarcode()">Look Up</button>
        </div>
      </div>
      <div id="scanResult"></div>
    </div>

    <div class="page" id="page-users">
      <div class="page-title">Users &amp; Access</div>
      <div class="page-sub">// manage lab members and permissions</div>
      <div class="toolbar" style="margin-bottom:18px">
        <button class="btn primary" onclick="openAddUserModal()">+ Add User</button>
      </div>
      <div id="userGrid"></div>
    </div>

    <div class="page" id="page-alerts">
      <div class="page-title">Alert Configuration</div>
      <div class="page-sub">// configure stock thresholds and expiry warnings</div>
      <div id="alertsConfig"></div>
    </div>

    <div class="page" id="page-email">
      <div class="page-title">Email Alert Settings</div>
      <div class="page-sub">// automatic email alerts via EmailJS</div>
      <div id="emailContent"></div>
    </div>

    <div class="page" id="page-labsettings">
      <div class="page-title">Lab Settings</div>
      <div class="page-sub">// customize this system for your lab</div>
      <div id="labSettingsContent"></div>
    </div>

  </div>
</div>

<!-- NOTIFICATIONS -->
<div class="notif-panel" id="notifPanel">
  <div class="notif-title">&#128276; Notifications</div>
  <div id="notifList"></div>
</div>

<!-- ITEM MODAL -->
<div class="modal-overlay" id="itemModal">
  <div class="modal lg">
    <div class="modal-header">
      <div class="modal-title" id="modalTitle">Add Item</div>
      <button class="modal-close" onclick="closeModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div class="form-section-label">Item Photo (Optional)</div>
      <div id="imgUploadWrap"></div>

      <div class="form-section-label" style="margin-top:10px">Basic Information</div>
      <div class="form-grid">
        <div class="field">
          <label>Item Name *</label>
          <input type="text" id="f-name" placeholder="e.g. Anti-CD3 Antibody" oninput="suggestCategory()">
          <div id="catSuggest" style="display:none;margin-top:3px"></div>
        </div>
        <div class="field">
          <label>Barcode ID</label>
          <input type="text" id="f-barcode" placeholder="Auto-generated">
        </div>
        <div class="field">
          <label>Category *</label>
          <select id="f-cat" onchange="toggleCasField()">
            <option>Antibody</option><option>Chemical</option><option>Buffer</option>
            <option>Enzyme</option><option>Cell Culture</option><option>Kit</option>
            <option>Primer</option><option>Plasmid</option>
            <option>General Lab Supplies</option><option>Other</option>
          </select>
        </div>
        <div class="field">
          <label>Storage Temperature *</label>
          <select id="f-temp" onchange="document.getElementById('f-temp-custom-wrap').style.display=this.value==='custom'?'block':'none'">
            <option value="">-- Select temperature --</option>
            <option value="RT">Room Temp (RT)</option>
            <option value="4C">Refrigerated (4 C)</option>
            <option value="-20C">Freezer (-20 C)</option>
            <option value="-80C">Ultra-low Freezer (-80 C)</option>
            <option value="-196C">Liquid Nitrogen (-196 C)</option>
            <option value="37C">Incubator (37 C)</option>
            <option value="custom">Custom...</option>
          </select>
        </div>
        <div class="field" id="f-temp-custom-wrap" style="display:none">
          <label>Custom Temperature</label>
          <input type="text" id="f-temp-custom" placeholder="e.g. 2-8 C">
        </div>
      </div>

      <div class="form-section-label" style="margin-top:8px">Vendor &amp; Catalog</div>
      <div class="form-grid">
        <div class="field">
          <label>Vendor / Supplier</label>
          <input type="text" id="f-vendor" placeholder="e.g. BioLegend" oninput="showVendorSuggestions()">
          <div id="vendorSuggest" style="margin-top:3px;display:flex;gap:3px;flex-wrap:wrap"></div>
        </div>
        <div class="field">
          <label>Catalog # (Cat #)</label>
          <input type="text" id="f-catnum" placeholder="e.g. 317302">
        </div>
        <div class="field">
          <label>Lot Number</label>
          <input type="text" id="f-lotnum" placeholder="e.g. B12345">
        </div>
        <div class="field" id="casField" style="display:none">
          <label>CAS # (Chemicals only)</label>
          <input type="text" id="f-cas" placeholder="e.g. 64-17-5">
        </div>
      </div>

      <div class="form-section-label" style="margin-top:8px">Stock &amp; Expiry</div>
      <div class="form-grid">
        <div class="field">
          <label>Quantity *</label>
          <input type="number" id="f-qty" placeholder="0" min="0">
        </div>
        <div class="field">
          <label>Unit</label>
          <select id="f-unit">
            <option>mL</option><option>uL</option><option>mg</option><option>g</option>
            <option>kg</option><option>units</option><option>vials</option><option>boxes</option><option>L</option>
          </select>
        </div>
        <div class="field">
          <label>Low Stock Threshold</label>
          <input type="number" id="f-threshold" placeholder="e.g. 10" min="0">
        </div>
        <div class="field">
          <label>Expiry Date</label>
          <input type="date" id="f-expiry">
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>Location *</label>
          <input type="text" id="f-location" placeholder="e.g. Fridge A, Shelf 2">
        </div>
      </div>

      <div class="form-section-label" style="margin-top:8px">Safety &amp; Docs</div>
      <div class="form-grid">
        <div class="field">
          <label>Hazard Category</label>
          <select id="f-hazard">
            <option value="">None</option><option>Flammable</option><option>Corrosive</option>
            <option>Toxic</option><option>Oxidizer</option><option>Carcinogen</option>
            <option>Biohazard</option><option>Radioactive</option><option>Irritant</option>
          </select>
        </div>
        <div class="field">
          <label>SDS Link</label>
          <input type="text" id="f-sds" placeholder="https://...">
        </div>
      </div>
      <div class="form-grid full" style="margin-top:14px">
        <div class="field">
          <label>Notes</label>
          <textarea id="f-notes" placeholder="Storage conditions, lot number, clone info..."></textarea>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeModal()">Cancel</button>
        <button class="btn primary" id="saveItemBtn" onclick="saveItem()">Save Item</button>
      </div>
    </div>
  </div>
</div>

<!-- USER MODAL -->
<div class="modal-overlay" id="userModal">
  <div class="modal sm">
    <div class="modal-header">
      <div class="modal-title" id="userModalTitle">Add User</div>
      <button class="modal-close" onclick="closeUserModal()">&#10005;</button>
    </div>
    <div class="modal-body">
      <div style="background:rgba(0,119,204,0.06);border:1px solid rgba(0,119,204,0.2);border-radius:8px;padding:10px 14px;font-family:var(--mono);font-size:11px;color:var(--text2);margin-bottom:16px;">
        The new member must <strong>register themselves</strong> using the login screen first. Then you can change their role here.
      </div>
      <div class="form-grid full">
        <div class="field"><label>Email (existing Firebase user)</label><input type="email" id="u-email" placeholder="member@lab.edu"></div>
        <div class="field">
          <label>Role</label>
          <select id="u-role">
            <option value="manager">Manager — full access</option>
            <option value="user" selected>User — inventory and scan only</option>
          </select>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn" onclick="closeUserModal()">Cancel</button>
        <button class="btn primary" onclick="saveUserRole()">Save Role</button>
      </div>
    </div>
  </div>
</div>

<!-- LIGHTBOX -->
<div class="lightbox" id="lightbox" onclick="closeLightbox()">
  <span class="lightbox-close">&#10005;</span>
  <img id="lightboxImg" src="" alt="">
</div>

<div class="toast-container" id="toastContainer"></div>

<script>
// ════════════════════════════════════════════════════
//  EMAILJS CREDENTIALS — hardcoded & active
// ════════════════════════════════════════════════════
const EMAILJS_PUBLIC_KEY  = 'XkiSKKi0wQPnRvOC7';
const EMAILJS_SERVICE_ID  = 'service_2w6r21f';
const EMAILJS_TEMPLATE_ID = 'template_u04i8fp';

// ════════════════════════════════════════════════════
//  ORDER STATUS CONFIG
// ════════════════════════════════════════════════════
const ORDER_STATUSES = [
  { key:'none',        label:'No Action',         dot:'#bbb',    cls:'osb-none',        icon:'O'  },
  { key:'notice',      label:'Notice / Needed',   dot:'#d97706', cls:'osb-notice',      icon:'!'  },
  { key:'inprogress',  label:'Order In Progress', dot:'#6d28d9', cls:'osb-inprogress',  icon:'*'  },
  { key:'approved',    label:'Approved',          dot:'#0077cc', cls:'osb-approved',    icon:'OK' },
  { key:'shipped',     label:'Shipped',           dot:'#0891b2', cls:'osb-shipped',     icon:'>>' },
  { key:'delivered',   label:'Delivered',         dot:'#16a34a', cls:'osb-delivered',   icon:'IN' },
  { key:'backordered', label:'Back-ordered',      dot:'#dc2626', cls:'osb-backordered', icon:'BO' },
];
function getStatusCfg(k){ return ORDER_STATUSES.find(s=>s.key===(k||'none'))||ORDER_STATUSES[0]; }

// ════════════════════════════════════════════════════
//  APP STATE
// ════════════════════════════════════════════════════
let inventory        = [];
let usageHistory     = [];
let userProfiles     = {};   // uid -> {name, email, role}
let currentUser      = null; // Firebase Auth user
let currentProfile   = null; // {name, email, role}
let editingId        = null;
let editingUserEmail = null;
let viewMode         = 'flat';
let catSortState     = {};
let catCollapsed     = {};
let orderFilterStatus = 'all';
let activeStatusPopup = null;
let currentItemImage  = null;
let unsubInventory    = null; // Firestore listener
let emailSettings     = { enabled:true, lowStock:true, expiry:true, expiryDays:30, managerEmail:'',
  ejsPublicKey:'XkiSKKi0wQPnRvOC7', ejsServiceId:'service_2w6r21f', ejsTemplateId:'template_u04i8fp' };
// ── LAB NAME CONFIG ─────────────────────────────────────
// Change 'Gao Lab' below to your lab name, then save.
// You can also change it live inside the app:
//   Log in as Manager → Lab Settings (bottom of sidebar)
let labSettings       = { labName:'Gao Lab', labSubtitle:'Inventory System', accentColor:'#0077cc' };
// ────────────────────────────────────────────────────────
let emailLog          = [];
let alertSentLog      = JSON.parse(localStorage.getItem('gao-alert-log')||'{}');

const knownVendors = ['Abcam','BioLegend','Cell Signaling','Gibco','Invitrogen','Millipore','NEB',
  'Promega','Qiagen','R&D Systems','Sigma-Aldrich','Thermo Fisher','Santa Cruz',
  'BD Biosciences','VWR','Fisher Scientific','Cayman Chemical','Tocris'];

function genId(){ return '_'+Math.random().toString(36).slice(2,11)+Date.now().toString(36); }
function isManager(){ return currentProfile?.role==='manager'; }
function saveAlertLog(){ localStorage.setItem('gao-alert-log',JSON.stringify(alertSentLog)); }

// ════════════════════════════════════════════════════
//  FIREBASE HELPERS  (wait for module to load)
// ════════════════════════════════════════════════════
function fb(){ return window.__fb; }

// ════════════════════════════════════════════════════
//  AUTH
// ════════════════════════════════════════════════════
function showRegisterPanel(){
  const p=document.getElementById('registerPanel');
  p.style.display=p.style.display==='none'?'block':'none';
}

async function doLogin(){
  const email=document.getElementById('loginEmail').value.trim();
  const pass =document.getElementById('loginPass').value;
  if(!email||!pass){showLoginErr('Please enter email and password.');return;}
  const btn=document.getElementById('loginBtn');
  btn.disabled=true;
  btn.innerHTML='<span class="login-spinner"></span>Signing in...';
  try{
    const {auth,signInWithEmailAndPassword}=fb();
    await signInWithEmailAndPassword(auth,email,pass);
  }catch(e){
    showLoginErr(friendlyAuthError(e.code));
    btn.disabled=false; btn.textContent='Sign In';
  }
}

async function doRegister(){
  const name =document.getElementById('regName').value.trim();
  const email=document.getElementById('regEmail').value.trim();
  const pass =document.getElementById('regPass').value;
  if(!name||!email||!pass){showRegErr('All fields required.');return;}
  if(pass.length<6){showRegErr('Password must be at least 6 characters.');return;}
  try{
    const {auth,createUserWithEmailAndPassword,db,setDoc,doc}=fb();
    const cred=await createUserWithEmailAndPassword(auth,email,pass);
    // Store profile in Firestore — first user gets manager role
    const usersSnap=await fb().getDocs(fb().collection(db,'users'));
    const role=usersSnap.empty?'manager':'user';
    await setDoc(doc(db,'users',cred.user.uid),{name,email,role,createdAt:new Date().toISOString()});
  }catch(e){
    showRegErr(friendlyAuthError(e.code));
  }
}

async function doSignOut(){
  if(!confirm('Sign out?')) return;
  if(unsubInventory) unsubInventory();
  const {auth,signOut}=fb();
  await signOut(auth);
  document.getElementById('loginScreen').style.display='flex';
  document.getElementById('appHeader').style.display='none';
  document.getElementById('appBody').style.display='none';
  inventory=[]; renderInventory();
}

function showLoginErr(msg){
  const el=document.getElementById('loginErr');
  el.textContent=msg; el.classList.add('show');
}
function showRegErr(msg){
  const el=document.getElementById('regErr');
  el.textContent=msg; el.classList.add('show');
}
function friendlyAuthError(code){
  const m={
    'auth/invalid-email':'Invalid email address.',
    'auth/user-not-found':'No account found for this email.',
    'auth/wrong-password':'Incorrect password.',
    'auth/email-already-in-use':'This email is already registered.',
    'auth/too-many-requests':'Too many attempts. Please wait and try again.',
    'auth/network-request-failed':'Network error. Check your connection.',
    'auth/invalid-credential':'Email or password is incorrect.',
  };
  return m[code]||'Error: '+code;
}

// ════════════════════════════════════════════════════
//  APP INIT (after auth)
// ════════════════════════════════════════════════════
async function initApp(user){
  currentUser=user;
  // Load user profile
  const {db,doc,getDoc,setDoc,collection,getDocs}=fb();
  const profSnap=await getDoc(doc(db,'users',user.uid));
  if(profSnap.exists()){
    currentProfile=profSnap.data();
  } else {
    // Auto-create profile for first-time users
    const usersSnap=await getDocs(collection(db,'users'));
    const role=usersSnap.empty?'manager':'user';
    currentProfile={name:user.email.split('@')[0],email:user.email,role};
    await setDoc(doc(db,'users',user.uid),{...currentProfile,createdAt:new Date().toISOString()});
  }

  // Load settings from Firestore
  const settingsSnap=await getDoc(doc(db,'settings','email'));
  if(settingsSnap.exists()) emailSettings={...emailSettings,...settingsSnap.data()};

  // Load lab settings
  const labSnap=await getDoc(doc(db,'settings','lab'));
  if(labSnap.exists()) labSettings={...labSettings,...labSnap.data()};
  applyLabBranding();

  // Load email log
  const logSnap=await getDoc(doc(db,'settings','emailLog'));
  if(logSnap.exists()) emailLog=logSnap.data().entries||[];

  // Show app
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('appHeader').style.display='flex';
  document.getElementById('appBody').style.display='flex';

  document.getElementById('currentUserName').textContent=currentProfile.name||user.email;
  const rb=document.getElementById('currentRoleBadge');
  rb.textContent=currentProfile.role.toUpperCase();
  rb.className='role-badge '+currentProfile.role;

  setSyncStatus('connected');
  currentPage='inventory';
  renderSidebar();
  startInventoryListener();
}

// ════════════════════════════════════════════════════
//  FIRESTORE REAL-TIME LISTENER
// ════════════════════════════════════════════════════
function startInventoryListener(){
  const {db,collection,onSnapshot,query,orderBy}=fb();
  setSyncStatus('syncing');
  if(unsubInventory) unsubInventory();
  unsubInventory=onSnapshot(
    query(collection(db,'inventory'),orderBy('name')),
    snap=>{
      inventory=snap.docs.map(d=>({id:d.id,...d.data()}));
      setSyncStatus('connected');
      renderInventory();
      checkAndSendEmailAlerts();
    },
    err=>{ console.error(err); setSyncStatus('offline'); showToast('Firestore connection error','error'); }
  );
}

function setSyncStatus(status){
  const dot=document.getElementById('syncDot');
  const lbl=document.getElementById('syncLabel');
  if(!dot) return;
  dot.className='sync-dot';
  if(status==='syncing'){dot.classList.add('syncing');lbl.textContent='Syncing...';}
  else if(status==='offline'){dot.classList.add('offline');lbl.textContent='Offline';}
  else{lbl.textContent='Live — Firestore';}
}

// ════════════════════════════════════════════════════
//  FIRESTORE CRUD
// ════════════════════════════════════════════════════
async function fsAddItem(data){
  const {db,collection,addDoc,serverTimestamp}=fb();
  const ref=await addDoc(collection(db,'inventory'),{...data,updatedBy:currentUser.uid,updatedAt:serverTimestamp()});
  return ref.id;
}
async function fsUpdateItem(id,data){
  const {db,doc,updateDoc,serverTimestamp}=fb();
  await updateDoc(doc(db,'inventory',id),{...data,updatedBy:currentUser.uid,updatedAt:serverTimestamp()});
}
async function fsDeleteItem(id){
  const {db,doc,deleteDoc}=fb();
  await deleteDoc(doc(db,'inventory',id));
}
async function fsLogHistory(msg,type){
  const {db,collection,addDoc,serverTimestamp}=fb();
  await addDoc(collection(db,'history'),{msg,type,user:currentProfile.name||currentUser.email,time:new Date().toLocaleTimeString(),createdAt:serverTimestamp()});
}
async function fsSaveSettings(){
  const {db,doc,setDoc}=fb();
  await setDoc(doc(db,'settings','email'),emailSettings);
}
async function fsSaveEmailLog(){
  const {db,doc,setDoc}=fb();
  await setDoc(doc(db,'settings','emailLog'),{entries:emailLog.slice(0,100)});
}

// ════════════════════════════════════════════════════
//  SIDEBAR
// ════════════════════════════════════════════════════
let currentPage='inventory';
function renderSidebar(){
  let html=`<div class="nav-section">Inventory</div>
    <div class="nav-item ${currentPage==='inventory'?'active':''}" onclick="showPage('inventory')">
      <span class="nav-icon">&#9879;</span> Inventory
    </div>
    <div class="nav-item ${currentPage==='scan'?'active':''}" onclick="showPage('scan')">
      <span class="nav-icon">&#9638;</span> Barcode Scan
    </div>`;
  if(isManager()){
    html+=`<div class="nav-item ${currentPage==='orders'?'active':''}" onclick="showPage('orders')">
        <span class="nav-icon">&#128230;</span> Order Tracker
      </div>
      <div class="nav-item ${currentPage==='analytics'?'active':''}" onclick="showPage('analytics')">
        <span class="nav-icon">&#128200;</span> Analytics
      </div>
      <div class="nav-divider"></div>
      <div class="nav-section">Management</div>
      <div class="nav-item ${currentPage==='users'?'active':''}" onclick="showPage('users')">
        <span class="nav-icon">&#128101;</span> Users
      </div>
      <div class="nav-item ${currentPage==='alerts'?'active':''}" onclick="showPage('alerts')">
        <span class="nav-icon">&#9888;</span> Alerts
      </div>
      <div class="nav-item ${currentPage==='email'?'active':''}" onclick="showPage('email')">
        <span class="nav-icon">&#9993;</span> Email Alerts
      </div>`;
  }
  document.getElementById('sidebar').innerHTML=html;
}

// ════════════════════════════════════════════════════
//  IMAGE UPLOAD
// ════════════════════════════════════════════════════
function handleImageUpload(input){
  const file=input.files[0]; if(!file) return;
  if(file.size>2*1024*1024){showToast('Image too large (max 2MB for Firestore)','error');return;}
  const reader=new FileReader();
  reader.onload=e=>{ currentItemImage=e.target.result; renderImgPreview(); };
  reader.readAsDataURL(file);
}
function renderImgPreview(){
  const wrap=document.getElementById('imgUploadWrap');
  if(currentItemImage){
    wrap.innerHTML=`<div class="img-preview"><img src="${currentItemImage}" alt="Item photo" onclick="openLightbox('${currentItemImage}')"><div class="remove-img" onclick="removeImg()">x</div></div>`;
  } else {
    wrap.innerHTML=`<div class="img-upload-area" onclick="document.getElementById('imgFileInput').click()">
      <div style="font-size:28px;margin-bottom:6px;">&#128247;</div>
      <p style="font-family:var(--mono);font-size:11px;color:var(--text2)">Click to upload item photo</p>
      <small style="font-size:10px;color:var(--text3)">JPG, PNG — max 2MB</small>
    </div>
    <input type="file" id="imgFileInput" accept="image/*" style="display:none" onchange="handleImageUpload(this)">`;
  }
}
function removeImg(){ currentItemImage=null; renderImgPreview(); }
function openLightbox(src){ document.getElementById('lightboxImg').src=src; document.getElementById('lightbox').classList.add('open'); }
function closeLightbox(){ document.getElementById('lightbox').classList.remove('open'); }

// ════════════════════════════════════════════════════
//  ORDER STATUS
// ════════════════════════════════════════════════════
function buildStatusBadge(item){
  const s=getStatusCfg(item.orderStatus);
  const isLow=item.threshold>0&&item.quantity<=item.threshold;
  // Only show badge if: item is low stock, OR has an active status, OR user is manager
  if(!isLow&&s.key==='none'&&!isManager()) return '';
  if(s.key==='none'&&!isLow&&!isManager()) return '';
  if(isManager()){
    // Managers: full clickable dropdown
    const label=s.key==='none'?'+ Order Status':'['+s.icon+'] '+s.label;
    return `<span class="status-popup-wrap" id="spw-${item.id}">
      <span class="order-status-badge ${s.cls}" onclick="toggleStatusPopup(event,'${item.id}')">${label} &#9660;</span>
    </span>`;
  } else {
    // Regular users: read-only status badge (no click)
    if(s.key==='none') return '';
    return `<span class="order-status-badge ${s.cls}" style="cursor:default;opacity:0.85">[${s.icon}] ${s.label}</span>`;
  }
}

function toggleStatusPopup(e,itemId){
  e.stopPropagation();
  if(activeStatusPopup===itemId){closeStatusPopup();return;}
  closeStatusPopup();
  activeStatusPopup=itemId;
  const item=inventory.find(i=>i.id===itemId);
  const wrap=document.getElementById('spw-'+itemId);
  if(!wrap) return;
  const rect=wrap.getBoundingClientRect();
  const noteVal=(item.orderNote||'').replace(/"/g,'&quot;');
  const popup=document.createElement('div');
  popup.className='status-dropdown'; popup.id='status-popup-'+itemId;
  popup.innerHTML=`<div class="status-dropdown-title">Set Order Status</div>
    ${ORDER_STATUSES.map(s=>`<div class="status-option" onclick="setOrderStatus('${itemId}','${s.key}',document.getElementById('sn-${itemId}').value)">
      <div class="so-dot" style="background:${s.dot}"></div>
      <div class="so-label">[${s.icon}] ${s.label}</div>
      ${(item.orderStatus||'none')===s.key?'<span class="so-check">OK</span>':''}
    </div>`).join('')}
    <div class="status-note-row">
      <label>Note / PO# / Tracking</label>
      <input type="text" id="sn-${itemId}" value="${noteVal}" placeholder="Optional note" onclick="event.stopPropagation()">
    </div>`;
  const overlay=document.getElementById('statusOverlay');
  overlay.classList.add('active');
  overlay.appendChild(popup);
  // Position after append so we know popup height
  requestAnimationFrame(()=>{
    const ph=popup.offsetHeight, pw=popup.offsetWidth;
    const spaceBelow=window.innerHeight-rect.bottom;
    const top=spaceBelow>ph+8?rect.bottom+4:rect.top-ph-4;
    const left=Math.min(rect.left, window.innerWidth-pw-8);
    popup.style.top=top+'px';
    popup.style.left=Math.max(8,left)+'px';
  });
}

async function setOrderStatus(itemId,statusKey,note){
  const item=inventory.find(i=>i.id===itemId); if(!item) return;
  const old=item.orderStatus||'none';
  const newNote=note||'';
  const newHistory=[...(item.orderHistory||[]),{status:statusKey,note:newNote,user:currentProfile.name||currentUser.email,date:new Date().toLocaleString()}];
  closeStatusPopup();
  try{
    await fsUpdateItem(itemId,{orderStatus:statusKey,orderNote:newNote,orderHistory:newHistory});
    showToast('Status: '+getStatusCfg(statusKey).label,'success');
  }catch(e){showToast('Save failed: '+e.message,'error');}
}

function closeStatusPopup(){
  if(activeStatusPopup){
    const el=document.getElementById('status-popup-'+activeStatusPopup);if(el)el.remove();
    const overlay=document.getElementById('statusOverlay');
    if(overlay){overlay.classList.remove('active');overlay.innerHTML='';}
    activeStatusPopup=null;
  }
}
document.addEventListener('click',e=>{if(activeStatusPopup&&!e.target.closest('.status-popup-wrap'))closeStatusPopup();});

// ════════════════════════════════════════════════════
//  STATS
// ════════════════════════════════════════════════════
function renderStats(){
  const low=inventory.filter(i=>i.threshold>0&&i.quantity<=i.threshold).length;
  const soon=inventory.filter(i=>{if(!i.expiry)return false;const d=(new Date(i.expiry)-new Date())/86400000;return d<=30&&d>=0;}).length;
  const ordering=inventory.filter(i=>i.orderStatus&&!['none','delivered'].includes(i.orderStatus)).length;
  document.getElementById('statsRow').innerHTML=`
    <div class="stat-card info"><div class="slabel">Total Items</div><div class="svalue">${inventory.length}</div><div class="sdelta">${[...new Set(inventory.map(i=>i.category))].length} categories</div></div>
    <div class="stat-card ${low>0?'warn':'ok'}"><div class="slabel">Low Stock</div><div class="svalue">${low}</div><div class="sdelta">below threshold</div></div>
    <div class="stat-card ${soon>0?'caution':'ok'}"><div class="slabel">Expiring Soon</div><div class="svalue">${soon}</div><div class="sdelta">within 30 days</div></div>
    <div class="stat-card purple"><div class="slabel">Orders Active</div><div class="svalue">${ordering}</div><div class="sdelta">being reordered</div></div>`;
}

// ════════════════════════════════════════════════════
//  INVENTORY RENDER
// ════════════════════════════════════════════════════
function setViewMode(mode){
  viewMode=mode;
  document.getElementById('viewFlat').classList.toggle('active',mode==='flat');
  document.getElementById('viewCat').classList.toggle('active',mode==='category');
  renderInventory();
}

function getFilteredItems(){
  const q=(document.getElementById('searchInput')||{value:''}).value.toLowerCase();
  const sort=(document.getElementById('filterSort')||{value:'alpha'}).value;
  let items=inventory.filter(i=>!q||[i.name,i.category,i.location,i.barcode,i.vendor,i.catNum,i.casNum].some(v=>v&&v.toLowerCase().includes(q)));
  return sortItems(items,sort);
}

function sortItems(items,sort){
  const s=[...items];
  if(sort==='alpha') s.sort((a,b)=>a.name.localeCompare(b.name));
  else if(sort==='alpha-desc') s.sort((a,b)=>b.name.localeCompare(a.name));
  else if(sort==='qty-asc') s.sort((a,b)=>a.quantity-b.quantity);
  else if(sort==='qty-desc') s.sort((a,b)=>b.quantity-a.quantity);
  else if(sort==='expiry') s.sort((a,b)=>{if(!a.expiry)return 1;if(!b.expiry)return -1;return new Date(a.expiry)-new Date(b.expiry);});
  else if(sort==='vendor') s.sort((a,b)=>(a.vendor||'').localeCompare(b.vendor||'')||a.name.localeCompare(b.name));
  else if(sort==='location') s.sort((a,b)=>(a.location||'').localeCompare(b.location||'')||a.name.localeCompare(b.name));
  return s;
}

function renderInventory(){
  if(!currentUser) return;
  renderStats(); renderNotifications();
  const addBtn=document.getElementById('addItemBtn');
  if(addBtn) addBtn.style.display='';
  const items=getFilteredItems();
  if(viewMode==='flat') renderFlatTable(items);
  else renderCategoryView(items);
}

function renderFlatTable(items){
  document.getElementById('inventoryContent').innerHTML=`
    <div class="table-wrap"><table>
      <thead><tr>
        <th>Name &amp; Order Status</th><th>Category</th>
        <th>Qty</th><th>Unit</th><th>Temp</th>
        <th>Location</th><th>Hazard</th><th>Expiry</th><th>Actions</th>
      </tr></thead>
      <tbody>${items.length?items.map(i=>renderRow(i)).join(''):'<tr><td colspan="9"><div class="empty"><div class="e-icon">&#128300;</div>No items found.</div></td></tr>'}</tbody>
    </table></div>`;
}

function renderCategoryView(items){
  const categories=[...new Set(items.map(i=>i.category))].sort();
  if(!categories.length){document.getElementById('inventoryContent').innerHTML='<div class="empty"><div class="e-icon">&#128300;</div>No items found.</div>';return;}
  const sortOpts=[{k:'alpha',l:'Name'},{k:'vendor',l:'Vendor'},{k:'qty-asc',l:'Qty+'},{k:'qty-desc',l:'Qty-'},{k:'location',l:'Location'},{k:'expiry',l:'Expiry'}];
  const th='style="background:var(--surface2);padding:8px 14px;text-align:left;font-family:var(--mono);font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--text3);border-bottom:1px solid var(--border)"';
  document.getElementById('inventoryContent').innerHTML=categories.map(cat=>{
    const catItems=items.filter(i=>i.category===cat);
    const sort=catSortState[cat]||'alpha';
    const sorted=sortItems(catItems,sort);
    const collapsed=catCollapsed[cat]||false;
    const lowCount=catItems.filter(i=>i.threshold>0&&i.quantity<=i.threshold).length;
    return `<div class="category-section">
      <div class="category-header" onclick="toggleCatCollapse('${cat}')">
        <div class="cat-header-left">
          <span class="cat-title">${cat}</span>
          <span class="cat-count">${catItems.length} item${catItems.length!==1?'s':''}</span>
          ${lowCount?`<span style="font-size:9px;font-family:var(--mono);color:var(--red);background:rgba(220,38,38,0.08);border:1px solid rgba(220,38,38,0.2);padding:2px 6px;border-radius:4px;">! ${lowCount} low</span>`:''}
        </div>
        <span class="cat-toggle-icon ${collapsed?'':'open'}">v</span>
      </div>
      ${collapsed?'':`<div class="cat-body">
        <div class="cat-sort-bar"><span>Sort:</span>${sortOpts.map(s=>`<span class="sort-chip ${sort===s.k?'active':''}" onclick="setCatSort('${cat}','${s.k}')">${s.l}</span>`).join('')}</div>
        <div style="overflow-x:auto"><table style="width:100%;border-collapse:collapse;font-size:12px;min-width:600px">
          <thead><tr><th ${th}>Name &amp; Status</th><th ${th}>Qty</th><th ${th}>Unit</th><th ${th}>Temp</th><th ${th}>Location</th><th ${th}>Hazard</th><th ${th}>Expiry</th><th ${th}>Actions</th></tr></thead>
          <tbody>${sorted.map(item=>renderCatRow(item)).join('')}</tbody>
        </table></div>
      </div>`}
    </div>`;
  }).join('');
}

function toggleCatCollapse(cat){catCollapsed[cat]=!catCollapsed[cat];renderInventory();}
function setCatSort(cat,sort){catSortState[cat]=sort;renderInventory();}

function expiryStr(expiry){
  if(!expiry) return '<span style="color:var(--text3);font-size:10px">--</span>';
  const days=Math.round((new Date(expiry)-new Date())/86400000);
  const color=days<=0?'var(--red)':days<=30?'var(--yellow)':'var(--text2)';
  return `<span style="color:${color};font-family:var(--mono);font-size:10px">${days<=0?'Expired':days<=7?days+'d':expiry}</span>`;
}

function thumbCell(item){
  if(item.image) return `<img src="${item.image}" class="item-thumb" alt="" onclick="openLightbox('${item.image}')">`;
  return `<div class="item-thumb-placeholder" title="${isManager()?'Add photo':'No photo'}" ${isManager()?`onclick="quickUpload('${item.id}')"`:''}>${isManager()?'[+]':'--'}</div>`;
}

function quickUpload(itemId){
  const inp=document.createElement('input');inp.type='file';inp.accept='image/*';
  inp.onchange=async e=>{
    const file=e.target.files[0];if(!file)return;
    if(file.size>2*1024*1024){showToast('Image too large (max 2MB)','error');return;}
    const reader=new FileReader();
    reader.onload=async ev=>{
      try{await fsUpdateItem(itemId,{image:ev.target.result});showToast('Photo saved','success');}
      catch(err){showToast('Save failed','error');}
    };
    reader.readAsDataURL(file);
  };
  inp.click();
}

function nameCell(item){
  const isLow=item.threshold>0&&item.quantity<=item.threshold;
  return `<div style="display:flex;align-items:center;flex-wrap:wrap;gap:3px">
    <span class="item-name" style="${isLow?'color:var(--red)':''}">${item.name}</span>
    ${isLow?'<span class="low-badge">! LOW</span>':''}
    ${buildStatusBadge(item)}
  </div>
  <div style="font-size:9px;font-family:var(--mono);color:var(--text3);margin-top:1px">${item.barcode||''}</div>`;
}

function rowActions(item){
  return `
    <div class="icon-btn" onclick="editItem('${item.id}')" title="Edit">E</div>
    <div class="icon-btn" onclick="adjustQty('${item.id}')" title="Adjust qty">+/-</div>
    <div class="icon-btn del" onclick="deleteItem('${item.id}')" title="Delete">X</div>`;
}

function catClass(cat){
  const m={'Antibody':'cat-antibody','Chemical':'cat-chemical','Buffer':'cat-buffer',
    'Enzyme':'cat-enzyme','Cell Culture':'cat-cellculture','Kit':'cat-kit',
    'Primer':'cat-primer','Plasmid':'cat-plasmid','General Lab Supplies':'cat-supplies'};
  return m[cat]||'cat-other';
}
function renderRow(item){
  const isLow=item.threshold>0&&item.quantity<=item.threshold;
  const isMed=item.threshold>0&&item.quantity<=item.threshold*2&&!isLow;
  const qc=isLow?'low':isMed?'medium':'ok';
  return `<tr>
    <td style="min-width:160px;max-width:240px">${nameCell(item)}</td>
    <td style="white-space:nowrap"><span class="item-cat ${catClass(item.category)}">${item.category}</span></td>
    <td class="qty-cell ${qc}">${item.quantity}</td>
    <td style="font-family:var(--mono);font-size:13px;color:var(--text2)">${item.unit}</td>
    <td>${item.temp?`<span class="temp-badge">T: ${item.temp}</span>`:'--'}</td>
    <td style="font-size:13px;color:var(--text2)">${item.location||'--'}</td>
    <td>${item.hazard?`<span class="hazard-badge">! ${item.hazard}</span>`:'--'}</td>
    <td>${expiryStr(item.expiry)}</td>
    <td><div class="actions">${rowActions(item)}</div></td>
  </tr>`;
}

function renderCatRow(item){
  const isLow=item.threshold>0&&item.quantity<=item.threshold;
  const isMed=item.threshold>0&&item.quantity<=item.threshold*2&&!isLow;
  const qc=isLow?'low':isMed?'medium':'ok';
  const td='style="padding:8px 14px;border-bottom:1px solid var(--border);vertical-align:middle"';
  return `<tr>
    <td ${td} style="padding:8px 14px;border-bottom:1px solid var(--border);vertical-align:middle;min-width:150px;max-width:220px">${nameCell(item)}</td>
    <td ${td}><span class="qty-cell ${qc}">${item.quantity}</span></td>
    <td ${td} style="font-family:var(--mono);font-size:13px;color:var(--text2);padding:8px 14px;border-bottom:1px solid var(--border);vertical-align:middle">${item.unit}</td>
    <td ${td}>${item.temp?`<span class="temp-badge">T: ${item.temp}</span>`:'--'}</td>
    <td ${td} style="font-size:13px;color:var(--text2);padding:8px 14px;border-bottom:1px solid var(--border);vertical-align:middle">${item.location||'--'}</td>
    <td ${td}>${item.hazard?`<span class="hazard-badge">! ${item.hazard}</span>`:'--'}</td>
    <td ${td}>${expiryStr(item.expiry)}</td>
    <td ${td}><div class="actions">${rowActions(item)}</div></td>
  </tr>`;
}

// ════════════════════════════════════════════════════
//  ITEM CRUD
// ════════════════════════════════════════════════════
function openAddModal(){
  editingId=null; currentItemImage=null;
  document.getElementById('modalTitle').textContent='Add Item';
  ['f-name','f-barcode','f-vendor','f-catnum','f-lotnum','f-cas','f-location','f-sds','f-notes','f-temp-custom'].forEach(id=>{const el=document.getElementById(id);if(el)el.value='';});
  document.getElementById('f-barcode').value='PD-'+String(inventory.length+1).padStart(5,'0');
  document.getElementById('f-cat').value='Antibody';
  document.getElementById('f-qty').value='';
  document.getElementById('f-unit').value='mL';
  document.getElementById('f-threshold').value='';
  document.getElementById('f-expiry').value='';
  document.getElementById('f-hazard').value='';
  document.getElementById('f-temp').value='';
  document.getElementById('f-temp-custom-wrap').style.display='none';
  document.getElementById('catSuggest').style.display='none';
  document.getElementById('casField').style.display='none';
  renderImgPreview();
  document.getElementById('itemModal').classList.add('open');
}

function editItem(id){
  const item=inventory.find(i=>i.id===id);if(!item)return;
  editingId=id; currentItemImage=item.image||null;
  document.getElementById('modalTitle').textContent='Edit Item';
  document.getElementById('f-name').value=item.name;
  document.getElementById('f-barcode').value=item.barcode||'';
  document.getElementById('f-cat').value=item.category;
  document.getElementById('f-vendor').value=item.vendor||'';
  document.getElementById('f-catnum').value=item.catNum||'';
  document.getElementById('f-cas').value=item.casNum||'';
  document.getElementById('f-location').value=item.location||'';
  document.getElementById('f-qty').value=item.quantity;
  document.getElementById('f-unit').value=item.unit;
  document.getElementById('f-threshold').value=item.threshold||'';
  document.getElementById('f-expiry').value=item.expiry||'';
  document.getElementById('f-hazard').value=item.hazard||'';
  document.getElementById('f-sds').value=item.sds||'';
  document.getElementById('f-lotnum').value=item.lotNum||'';
  document.getElementById('f-notes').value=item.notes||'';
  const knownTemps=['RT','4C','-20C','-80C','-196C','37C',''];
  if(knownTemps.includes(item.temp||'')){document.getElementById('f-temp').value=item.temp||'';document.getElementById('f-temp-custom-wrap').style.display='none';}
  else{document.getElementById('f-temp').value='custom';document.getElementById('f-temp-custom').value=item.temp||'';document.getElementById('f-temp-custom-wrap').style.display='block';}
  toggleCasField();
  document.getElementById('catSuggest').style.display='none';
  renderImgPreview();
  document.getElementById('itemModal').classList.add('open');
}

function closeModal(){document.getElementById('itemModal').classList.remove('open');}

async function saveItem(){
  const name=document.getElementById('f-name').value.trim();
  const qty=Number(document.getElementById('f-qty').value);
  const tempSel=document.getElementById('f-temp').value;
  const temp=tempSel==='custom'?document.getElementById('f-temp-custom').value.trim():tempSel;
  if(!name||isNaN(qty)||qty<0){showToast('Please fill required fields (Name, Quantity)','error');return;}
  if(!temp){showToast('Storage Temperature is required','error');document.getElementById('f-temp').focus();return;}
  const location=document.getElementById('f-location').value.trim();
  if(!location){showToast('Location is required','error');document.getElementById('f-location').focus();return;}
  const existing=editingId?inventory.find(i=>i.id===editingId):null;
  const data={
    barcode:document.getElementById('f-barcode').value.trim()||'PD-'+Date.now(),
    name, category:document.getElementById('f-cat').value,
    vendor:document.getElementById('f-vendor').value.trim(),
    catNum:document.getElementById('f-catnum').value.trim(),
    casNum:document.getElementById('f-cas').value.trim(),
    quantity:qty, unit:document.getElementById('f-unit').value,
    location:document.getElementById('f-location').value.trim(),
    threshold:Number(document.getElementById('f-threshold').value)||0,
    expiry:document.getElementById('f-expiry').value,
    hazard:document.getElementById('f-hazard').value,
    sds:document.getElementById('f-sds').value.trim(),
    lotNum:document.getElementById('f-lotnum').value.trim(),
    notes:document.getElementById('f-notes').value.trim(),
    temp, image:currentItemImage||'',
    orderStatus:existing?.orderStatus||'none',
    orderNote:existing?.orderNote||'',
    orderHistory:existing?.orderHistory||[]
  };
  const btn=document.getElementById('saveItemBtn');
  btn.disabled=true; btn.textContent='Saving...';
  try{
    if(editingId){
      await fsUpdateItem(editingId,data);
      showToast('Item updated in Firestore','success');
    } else {
      await fsAddItem(data);
      showToast('Item added to Firestore','success');
    }
    closeModal();
  }catch(e){showToast('Save failed: '+e.message,'error');}
  finally{btn.disabled=false;btn.textContent='Save Item';}
}

async function deleteItem(id){
  const item=inventory.find(i=>i.id===id);
  if(!confirm('Delete "'+item.name+'"?')) return;
  try{
    await fsDeleteItem(id);
    showToast('Item deleted','error');
  }catch(e){showToast('Delete failed: '+e.message,'error');}
}

async function adjustQty(id){
  const item=inventory.find(i=>i.id===id);
  const val=prompt('Update quantity for "'+item.name+'"\nCurrent: '+item.quantity+' '+item.unit+'\nEnter new quantity:');
  if(val===null) return;
  const n=Number(val);
  if(isNaN(n)||n<0){showToast('Invalid quantity','error');return;}
  try{
    const update={quantity:n};
    // Auto-reset to No Action if qty is now above threshold (item restocked)
    if(item.threshold>0&&n>item.threshold&&item.orderStatus&&item.orderStatus!=='none'){
      update.orderStatus='none';
      update.orderNote='';
      update.orderHistory=[...(item.orderHistory||[]),{
        status:'none',note:'Auto-reset: quantity restocked above threshold',
        user:currentProfile?.name||currentUser?.email||'system',
        date:new Date().toLocaleString()
      }];
    }
    await fsUpdateItem(id,update);
    const autoMsg=update.orderStatus==='none'?' — Order status reset to No Action':'';
    showToast('Quantity updated'+autoMsg,'success');
  }catch(e){showToast('Update failed: '+e.message,'error');}
}

// ════════════════════════════════════════════════════
//  USERS PAGE
// ════════════════════════════════════════════════════
async function renderUsers(){
  const {db,collection,getDocs}=fb();
  const snap=await getDocs(collection(db,'users'));
  const users=snap.docs.map(d=>({uid:d.id,...d.data()}));
  document.getElementById('userGrid').innerHTML=`<div class="user-grid">`+
    users.map(u=>`<div class="user-card">
      <div class="u-name">${u.name||'(no name)'}</div>
      <div class="u-email">${u.email}</div>
      <span class="role-badge ${u.role}" style="display:inline-block;margin-bottom:10px">${(u.role||'user').toUpperCase()}</span>
      ${u.uid!==currentUser.uid?`<div style="display:flex;gap:6px">
        <button class="btn sm" onclick="openEditUserModal('${u.email}','${u.role}')">Edit Role</button>
        <button class="btn sm danger" onclick="removeUser('${u.uid}','${u.name||u.email}')">Remove</button>
      </div>`:'<div style="font-size:10px;font-family:var(--mono);color:var(--text3)">(you)</div>'}
    </div>`).join('')+`</div>`;
}

function openAddUserModal(){
  editingUserEmail=null;
  document.getElementById('userModalTitle').textContent='Set User Role';
  document.getElementById('u-email').value='';
  document.getElementById('u-email').readOnly=false;
  document.getElementById('u-role').value='user';
  document.getElementById('userModal').classList.add('open');
}

function openEditUserModal(email,currentRole){
  editingUserEmail=email;
  document.getElementById('userModalTitle').textContent='Edit Role';
  document.getElementById('u-email').value=email;
  document.getElementById('u-email').readOnly=true;
  document.getElementById('u-role').value=currentRole||'user';
  document.getElementById('userModal').classList.add('open');
}

function closeUserModal(){document.getElementById('userModal').classList.remove('open');}

async function saveUserRole(){
  const email=document.getElementById('u-email').value.trim();
  const role=document.getElementById('u-role').value;
  if(!email){showToast('Email required','error');return;}
  const {db,collection,getDocs,doc,updateDoc}=fb();
  const snap=await getDocs(collection(db,'users'));
  const userDoc=snap.docs.find(d=>d.data().email===email);
  if(!userDoc){showToast('No registered user found with that email. Ask them to register first.','error');return;}
  await updateDoc(doc(db,'users',userDoc.id),{role});
  closeUserModal(); showToast('Role updated','success'); renderUsers();
}

async function removeUser(uid,name){
  if(!confirm('Remove '+name+' from the system?')) return;
  const {db,doc,deleteDoc}=fb();
  await deleteDoc(doc(db,'users',uid));
  showToast('User removed','error'); renderUsers();
}

// ════════════════════════════════════════════════════
//  NOTIFICATIONS
// ════════════════════════════════════════════════════
function getNotifications(){
  const n=[];
  inventory.forEach(item=>{
    if(item.threshold>0&&item.quantity<=item.threshold) n.push({type:'danger',title:'Low Stock: '+item.name,sub:item.quantity+' '+item.unit+' left (threshold: '+item.threshold+')'});
    if(item.expiry){const days=Math.round((new Date(item.expiry)-new Date())/86400000);if(days<=0)n.push({type:'danger',title:'Expired: '+item.name,sub:'Expired '+item.expiry});else if(days<=7)n.push({type:'danger',title:'Expiring in '+days+'d: '+item.name,sub:'Expires '+item.expiry});else if(days<=30)n.push({type:'warning',title:'Expiring soon: '+item.name,sub:days+' days left'});}
  });
  return n;
}
function renderNotifications(){
  const n=getNotifications();
  document.getElementById('notifCount').textContent=n.length;
  document.getElementById('notifList').innerHTML=n.length?n.map(n=>`<div class="notif-item ${n.type}"><div class="n-title">${n.title}</div><div class="n-sub">${n.sub}</div></div>`).join(''):'<div style="color:var(--green);font-size:12px;font-family:var(--mono)">All clear</div>';
}
function toggleNotifPanel(){document.getElementById('notifPanel').classList.toggle('open');}

// ════════════════════════════════════════════════════
//  ALERTS CONFIG
// ════════════════════════════════════════════════════
function renderAlertsConfig(){
  document.getElementById('alertsConfig').innerHTML=`
    <div style="max-width:640px">
      <div class="chart-card" style="margin-bottom:18px">
        <h3>Active Alerts</h3>
        ${getNotifications().map(n=>`<div class="notif-item ${n.type}" style="margin-bottom:8px"><div class="n-title">${n.title}</div><div class="n-sub">${n.sub}</div></div>`).join('')||'<div style="color:var(--green);font-size:12px;font-family:var(--mono)">No active alerts</div>'}
      </div>
      <div class="chart-card">
        <h3>Per-Item Thresholds</h3>
        <div style="margin-top:10px;display:flex;flex-direction:column;gap:7px">
          ${inventory.map(i=>`<div class="alert-item-row"><span class="ai-name">${i.name}</span><span style="color:var(--text2);font-size:10px">Qty: <strong style="color:${i.quantity<=i.threshold&&i.threshold>0?'var(--red)':'var(--green)'}">${i.quantity}</strong></span><span style="color:var(--text3);font-size:10px">Alert at:</span><input type="number" value="${i.threshold}" min="0" style="width:58px;background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:3px 7px;color:var(--text);font-family:var(--mono);font-size:11px;text-align:center;outline:none" onchange="updateThreshold('${i.id}',this.value)"></div>`).join('')}
        </div>
      </div>
    </div>`;
}
async function updateThreshold(id,val){
  try{await fsUpdateItem(id,{threshold:Number(val)});showToast('Threshold updated','success');}
  catch(e){showToast('Update failed','error');}
}

// ════════════════════════════════════════════════════
//  ANALYTICS
// ════════════════════════════════════════════════════
async function renderAnalytics(){
  const {db,collection,getDocs,query,orderBy}=fb();
  const cats={},vendors={};
  inventory.forEach(i=>{cats[i.category]=(cats[i.category]||0)+1;if(i.vendor)vendors[i.vendor]=(vendors[i.vendor]||0)+1;});
  const sc=Object.entries(cats).sort((a,b)=>b[1]-a[1]);
  const sv=Object.entries(vendors).sort((a,b)=>b[1]-a[1]);
  const mc=sc[0]?.[1]||1,mv=sv[0]?.[1]||1;
  const clrs=['#0077cc','#6d28d9','#16a34a','#d97706','#ea580c','#dc2626','#0891b2','#7c3aed'];
  const low=inventory.filter(i=>i.threshold>0&&i.quantity<=i.threshold);
  // Load history from Firestore
  let histHtml='<div style="color:var(--text3);font-family:var(--mono)">No history yet</div>';
  try{
    const hSnap=await getDocs(query(collection(db,'history'),orderBy('createdAt','desc')));
    const hist=hSnap.docs.slice(0,15).map(d=>d.data());
    if(hist.length) histHtml=`<div class="history-table">${hist.map(h=>`<div class="h-row"><span class="h-action">[${h.type.toUpperCase()}]</span><span style="color:var(--text);flex:1">${h.msg}</span><span class="h-time">${h.time||''} ${h.user||''}</span></div>`).join('')}</div>`;
  }catch(e){}
  document.getElementById('analyticsContent').innerHTML=`
    <div class="chart-card"><h3>By Category</h3><div class="bar-chart">${sc.map(([c,n],i)=>`<div class="bar-row"><div class="bar-label" title="${c}">${c.length>11?c.slice(0,11)+'...':c}</div><div class="bar-track"><div class="bar-fill" style="width:${(n/mc*100).toFixed(0)}%;background:${clrs[i%clrs.length]}"><span>${n}</span></div></div></div>`).join('')}</div></div>
    <div class="chart-card"><h3>By Vendor</h3><div class="bar-chart">${sv.length?sv.slice(0,8).map(([v,n],i)=>`<div class="bar-row"><div class="bar-label" title="${v}">${v.length>11?v.slice(0,11)+'...':v}</div><div class="bar-track"><div class="bar-fill" style="width:${(n/mv*100).toFixed(0)}%;background:${clrs[i%clrs.length]}"><span>${n}</span></div></div></div>`).join(''):'<div style="color:var(--text3);font-size:11px;font-family:var(--mono)">No vendor data</div>'}</div></div>
    <div class="chart-card"><h3>Low Stock (${low.length})</h3>${low.length?`<div class="history-table">${low.map(i=>`<div class="h-row"><span style="color:var(--red)">! ${i.name}</span><span style="color:var(--text2)">${i.quantity}/${i.threshold} ${i.unit}</span></div>`).join('')}</div>`:'<div style="color:var(--green);font-family:var(--mono);font-size:11px">All healthy</div>'}</div>
    <div class="chart-card"><h3>Activity History</h3>${histHtml}</div>`;
}

// ════════════════════════════════════════════════════
//  BARCODE SCAN
// ════════════════════════════════════════════════════
async function scanBarcode(){
  const code=document.getElementById('barcodeInput').value.trim();if(!code)return;
  const item=inventory.find(i=>i.barcode===code);
  const el=document.getElementById('scanResult');
  if(!item){el.innerHTML=`<div class="scan-result" style="border-color:var(--red)"><div class="sr-label">RESULT</div><div class="sr-name" style="color:var(--red)">Not Found: "${code}"</div></div>`;return;}
  const isLow=item.threshold>0&&item.quantity<=item.threshold;
  try{await fsLogHistory('Scanned "'+item.name+'"','scan');}catch(e){}
  el.innerHTML=`<div class="scan-result" style="border-color:var(--accent)">
    <div class="sr-label">SCAN RESULT -- ${code}</div>
    ${item.image?`<img src="${item.image}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;border:1px solid var(--border);margin-bottom:8px;cursor:pointer" onclick="openLightbox('${item.image}')">`:'' }
    <div class="sr-name">${item.name}</div>
    <div class="sr-row"><span>Category</span><span>${item.category}</span></div>
    ${item.vendor?`<div class="sr-row"><span>Vendor</span><span>${item.vendor}</span></div>`:''}
    ${item.catNum?`<div class="sr-row"><span>Cat #</span><span>${item.catNum}</span></div>`:''}
    ${item.casNum?`<div class="sr-row"><span>CAS #</span><span>${item.casNum}</span></div>`:''}
    <div class="sr-row"><span>Quantity</span><span style="color:${isLow?'var(--red)':'var(--green)'};font-weight:700">${item.quantity} ${item.unit}${isLow?' -- LOW':''}</span></div>
    ${item.temp?`<div class="sr-row"><span>Storage Temp</span><span>${item.temp}</span></div>`:''}
    <div class="sr-row"><span>Location</span><span>${item.location||'N/A'}</span></div>
    <div class="sr-row"><span>Expiry</span><span>${item.expiry||'N/A'}</span></div>
    ${item.hazard?`<div class="sr-row"><span>Hazard</span><span style="color:var(--orange)">! ${item.hazard}</span></div>`:''}
  </div>`;
}

// ════════════════════════════════════════════════════
//  EMAIL ALERTS
// ════════════════════════════════════════════════════
function initEmailJS(){
  emailjs.init(EMAILJS_PUBLIC_KEY);
  return true;
}

async function sendRealEmail(toEmail,toName,subject,body){
  try{
    const svcId=emailSettings.ejsServiceId||EMAILJS_SERVICE_ID;
    const tplId=emailSettings.ejsTemplateId||EMAILJS_TEMPLATE_ID;
    await emailjs.send(svcId,tplId,{
      to_email:toEmail,to_name:toName,subject,message:body,from_name:'PharmDigits - '+(labSettings.labName||'Lab')
    });
    return true;
  }catch(e){console.error('EmailJS:',e);return false;}
}

async function checkAndSendEmailAlerts(forceAll=false){
  if(!emailSettings.enabled) return;
  const mgrEmail=emailSettings.managerEmail;
  if(!mgrEmail) return;
  const today=new Date().toDateString();
  const alerts=[];
  inventory.forEach(item=>{
    if(emailSettings.lowStock&&item.threshold>0&&item.quantity<=item.threshold){
      const key=item.id+'|lowstock';
      if(forceAll||!alertSentLog[key]||alertSentLog[key]!==today)
        alerts.push({key,to:mgrEmail,item,reason:'lowstock'});
    }
    if(emailSettings.expiry&&item.expiry){
      const days=Math.round((new Date(item.expiry)-new Date())/86400000);
      if(days>=0&&days<=(emailSettings.expiryDays||30)){
        const key=item.id+'|expiry';
        if(forceAll||!alertSentLog[key]||alertSentLog[key]!==today)
          alerts.push({key,to:mgrEmail,item,reason:'expiry',days});
      }
    }
  });
  if(!alerts.length) return;
  initEmailJS();
  let sent=0,failed=0;
  for(const a of alerts){
    const subject=a.reason==='lowstock'?'[PharmDigits] Low Stock: '+a.item.name:'[PharmDigits] Expiry Alert: '+a.item.name;
    const body=a.reason==='lowstock'
      ?'Low Stock Alert - Gao Lab\n\nItem: '+a.item.name+'\nCat#: '+(a.item.catNum||'N/A')+'\nCAS#: '+(a.item.casNum||'N/A')+'\nVendor: '+(a.item.vendor||'N/A')+'\nQty: '+a.item.quantity+' '+a.item.unit+' (threshold: '+a.item.threshold+')\nStorage: '+(a.item.temp||'N/A')+'\nLocation: '+(a.item.location||'N/A')+'\n\nPlease reorder.\n-- PharmDigits Gao Lab'
      :'Expiry Alert - Gao Lab\n\nItem: '+a.item.name+'\nExpiry: '+a.item.expiry+'\nDays left: '+a.days+'\nLocation: '+(a.item.location||'N/A')+'\n\n-- PharmDigits Gao Lab';
    const ok=await sendRealEmail(a.to,'Lab Manager',subject,body);
    if(ok){sent++;alertSentLog[a.key]=today;emailLog.unshift({date:new Date().toISOString(),to:a.to,subject,status:'sent'});}
    else{failed++;emailLog.unshift({date:new Date().toISOString(),to:a.to,subject,status:'failed'});}
  }
  if(emailLog.length>100) emailLog.splice(100);
  saveAlertLog();
  try{await fsSaveEmailLog();}catch(e){}
  if(sent>0) showToast(sent+' alert email'+( sent>1?'s':'')+' sent','info');
  if(failed>0) showToast(failed+' email'+(failed>1?'s':'')+' failed','warning');
}

function renderEmailPage(){
  const s=emailSettings;
  const log=emailLog||[];
  document.getElementById('emailContent').innerHTML=`
    <div style="max-width:700px">
      <div class="emailjs-setup">
        <h3>EmailJS Connection <span style="font-size:10px;padding:2px 10px;border-radius:10px;background:rgba(22,163,74,0.1);color:var(--green);border:1px solid rgba(22,163,74,0.2)">Active</span></h3>
        <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;margin-bottom:12px">
          <div class="field"><label>Public Key</label><input type="text" id="ejs-pubkey" value="${s.ejsPublicKey||EMAILJS_PUBLIC_KEY}" placeholder="Your public key" style="background:var(--surface2);border-color:var(--border);color:var(--text)"></div>
          <div class="field"><label>Service ID</label><input type="text" id="ejs-svcid" value="${s.ejsServiceId||EMAILJS_SERVICE_ID}" placeholder="service_xxxxxxx" style="background:var(--surface2);border-color:var(--border);color:var(--text)"></div>
          <div class="field"><label>Template ID</label><input type="text" id="ejs-tplid" value="${s.ejsTemplateId||EMAILJS_TEMPLATE_ID}" placeholder="template_xxxxxxx" style="background:var(--surface2);border-color:var(--border);color:var(--text)"></div>
        </div>
        <button class="btn primary sm" style="margin-bottom:10px" onclick="saveEmailJSCredentials()">Save EmailJS Credentials</button>
        <div style="font-size:11px;font-family:var(--mono);color:var(--text2);background:rgba(22,163,74,0.06);border:1px solid rgba(22,163,74,0.2);border-radius:8px;padding:9px 12px;">
          Your EmailJS template must have: <strong>{{to_email}}</strong>, <strong>{{to_name}}</strong>, <strong>{{subject}}</strong>, <strong>{{message}}</strong>
        </div>
      </div>
      <div class="email-config-card">
        <h3>Alert Settings</h3>
        <div class="email-row">
          <div><div class="er-label">Manager Alert Email</div><div class="er-sub">All alerts sent here</div></div>
          <input type="email" value="${s.managerEmail||''}" placeholder="manager@lab.edu" style="background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:5px 9px;font-family:var(--mono);font-size:11px;color:var(--text);outline:none;width:240px" onchange="updateEmailSetting('managerEmail',this.value)">
        </div>
        <div class="email-row"><div><div class="er-label">Low Stock Alerts</div></div><label class="toggle-switch"><input type="checkbox" ${s.lowStock?'checked':''} onchange="updateEmailSetting('lowStock',this.checked)"><span class="toggle-slider"></span></label></div>
        <div class="email-row"><div><div class="er-label">Expiry Alerts</div></div><label class="toggle-switch"><input type="checkbox" ${s.expiry?'checked':''} onchange="updateEmailSetting('expiry',this.checked)"><span class="toggle-slider"></span></label></div>
        <div class="email-row"><div><div class="er-label">Expiry Warning (days)</div></div><input type="number" value="${s.expiryDays||30}" min="1" max="365" style="width:60px;background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:4px 8px;font-family:var(--mono);font-size:12px;color:var(--text);outline:none;text-align:center" onchange="updateEmailSetting('expiryDays',Number(this.value))"></div>
        <div style="display:flex;gap:9px;margin-top:14px">
          <button class="btn primary sm" onclick="checkAndSendEmailAlerts(true)">Force Send All Alerts</button>
          <button class="btn sm" onclick="clearAlertLog()">Clear Log</button>
        </div>
      </div>
      <div class="email-config-card">
        <h3>Email Log (${log.length})</h3>
        ${log.length?log.slice(0,20).map(e=>`<div style="padding:8px 10px;background:var(--surface2);border:1px solid ${e.status==='sent'?'var(--border)':'rgba(220,38,38,0.3)'};border-left:3px solid ${e.status==='sent'?'var(--green)':'var(--red)'};border-radius:7px;margin-bottom:7px;font-size:11px;font-family:var(--mono)">
          <div style="font-weight:700">${e.subject}</div>
          <div style="color:var(--text2);margin-top:2px">To: ${e.to} -- ${new Date(e.date).toLocaleString()} -- <span style="color:${e.status==='sent'?'var(--green)':'var(--red)'}">● ${e.status}</span></div>
        </div>`).join(''):'<div style="color:var(--text3);font-size:12px;font-family:var(--mono)">No emails logged yet.</div>'}
      </div>
    </div>`;
}

async function saveEmailJSCredentials(){
  const pk=document.getElementById('ejs-pubkey').value.trim();
  const si=document.getElementById('ejs-svcid').value.trim();
  const ti=document.getElementById('ejs-tplid').value.trim();
  if(!pk||!si||!ti){showToast('All three EmailJS fields are required','error');return;}
  emailSettings.ejsPublicKey=pk;
  emailSettings.ejsServiceId=si;
  emailSettings.ejsTemplateId=ti;
  try{await fsSaveSettings();showToast('EmailJS credentials saved','success');}
  catch(e){showToast('Save failed: '+e.message,'error');}
}
async function updateEmailSetting(key,val){
  emailSettings[key]=val;
  try{await fsSaveSettings();}catch(e){}
  renderEmailPage();
  showToast('Saved','success');
}
async function clearAlertLog(){
  alertSentLog={}; emailLog=[];
  saveAlertLog();
  try{await fsSaveEmailLog();}catch(e){}
  renderEmailPage();
  showToast('Log cleared','success');
}

// ════════════════════════════════════════════════════
//  ORDER TRACKER PAGE
// ════════════════════════════════════════════════════
function renderOrderTracker(){
  const lowItems=inventory.filter(i=>i.threshold>0&&i.quantity<=i.threshold);
  const withStatus=inventory.filter(i=>i.orderStatus&&i.orderStatus!=='none');
  const tracked=[...new Map([...lowItems,...withStatus].map(i=>[i.id,i])).values()];
  const counts={all:tracked.length};
  ORDER_STATUSES.forEach(s=>{counts[s.key]=tracked.filter(i=>(i.orderStatus||'none')===s.key).length;});
  let filtered=orderFilterStatus==='all'?tracked:tracked.filter(i=>(i.orderStatus||'none')===orderFilterStatus);
  const inProgress=tracked.filter(i=>!['none','delivered'].includes(i.orderStatus||'none')).length;
  const delivered=tracked.filter(i=>i.orderStatus==='delivered').length;
  let html=`<div class="stats-row" style="margin-bottom:20px">
    <div class="stat-card warn"><div class="slabel">Low Stock</div><div class="svalue">${lowItems.length}</div><div class="sdelta">need reorder</div></div>
    <div class="stat-card purple"><div class="slabel">In Progress</div><div class="svalue">${inProgress}</div><div class="sdelta">active orders</div></div>
    <div class="stat-card ok"><div class="slabel">Delivered</div><div class="svalue">${delivered}</div></div>
    <div class="stat-card info"><div class="slabel">Total Tracked</div><div class="svalue">${tracked.length}</div></div>
  </div>
  <div class="order-filter-row">
    <span style="font-size:10px;font-family:var(--mono);color:var(--text3)">FILTER:</span>
    <span class="filter-chip ${orderFilterStatus==='all'?'active':''}" onclick="setOrderFilter('all')">All (${counts.all})</span>
    ${ORDER_STATUSES.filter(s=>counts[s.key]>0).map(s=>`<span class="filter-chip ${orderFilterStatus===s.key?'active':''}" onclick="setOrderFilter('${s.key}')">[${s.icon}] ${s.label} (${counts[s.key]})</span>`).join('')}
  </div>`;
  if(!filtered.length){
    html+=`<div class="empty"><div class="e-icon">&#128230;</div>No items to track yet.</div>`;
  } else {
    html+=filtered.map(item=>{
      const s=getStatusCfg(item.orderStatus);
      const isLow=item.threshold>0&&item.quantity<=item.threshold;
      const hist=(item.orderHistory||[]).slice(-4).reverse();
      const noteVal=(item.orderNote||'').replace(/"/g,'&quot;');
      return `<div class="order-card">
        <div class="order-card-left">
          <div class="order-card-name">${item.name}</div>
          <div class="order-card-meta">
            <span>${item.category}</span>
            ${item.vendor?`<span>${item.vendor}</span>`:''}
            ${item.catNum?`<span>Cat# ${item.catNum}</span>`:''}
            ${item.casNum?`<span>CAS# ${item.casNum}</span>`:''}
            <span style="color:${isLow?'var(--red)':'var(--text2)'}">Qty: ${item.quantity}/${item.threshold} ${item.unit}</span>
          </div>
          ${item.orderNote?`<div class="order-card-note">Note: ${item.orderNote}</div>`:''}
          ${hist.length?`<div class="timeline">${hist.map((h,i)=>`<div class="timeline-item"><div style="display:flex;flex-direction:column;align-items:center"><div class="timeline-dot" style="background:${getStatusCfg(h.status).dot}"></div>${i<hist.length-1?`<div class="timeline-connector"></div>`:''}</div><div class="timeline-content"><strong>${getStatusCfg(h.status).label}</strong> -- ${h.user} -- ${h.date}${h.note?`<br>${h.note}`:''}</div></div>`).join('')}</div>`:''}
        </div>
        <div class="order-card-right">
          ${isLow?`<span class="low-badge" style="animation:none">! LOW</span>`:''}
          <div class="status-popup-wrap" id="ot-spw-${item.id}">
            <span class="order-status-badge ${s.cls}" style="font-size:10px;padding:4px 10px" onclick="toggleStatusPopupOT(event,'${item.id}')">[${s.icon}] ${s.label} v</span>
          </div>
        </div>
      </div>`;
    }).join('');
  }
  document.getElementById('orderTrackerContent').innerHTML=html;
}

function setOrderFilter(st){orderFilterStatus=st;renderOrderTracker();}

function toggleStatusPopupOT(e,itemId){
  e.stopPropagation();
  if(activeStatusPopup==='ot-'+itemId){closeStatusPopup();return;}
  closeStatusPopup();
  activeStatusPopup='ot-'+itemId;
  const item=inventory.find(i=>i.id===itemId);
  const wrap=document.getElementById('ot-spw-'+itemId);
  if(!wrap) return;
  const rect=wrap.getBoundingClientRect();
  const noteVal=(item.orderNote||'').replace(/"/g,'&quot;');
  const popup=document.createElement('div');
  popup.className='status-dropdown';popup.id='status-popup-ot-'+itemId;
  popup.innerHTML=`<div class="status-dropdown-title">Set Order Status</div>
    ${ORDER_STATUSES.map(s=>`<div class="status-option" onclick="setOrderStatusOT('${itemId}','${s.key}',document.getElementById('otsn-${itemId}').value)">
      <div class="so-dot" style="background:${s.dot}"></div>
      <div class="so-label">[${s.icon}] ${s.label}</div>
      ${(item.orderStatus||'none')===s.key?'<span class="so-check">OK</span>':''}
    </div>`).join('')}
    <div class="status-note-row"><label>Note / PO# / Tracking</label><input type="text" id="otsn-${itemId}" value="${noteVal}" placeholder="Optional note" onclick="event.stopPropagation()"></div>`;
  const overlay=document.getElementById('statusOverlay');
  overlay.classList.add('active');
  overlay.appendChild(popup);
  requestAnimationFrame(()=>{
    const ph=popup.offsetHeight, pw=popup.offsetWidth;
    const spaceBelow=window.innerHeight-rect.bottom;
    const top=spaceBelow>ph+8?rect.bottom+4:rect.top-ph-4;
    const left=Math.min(rect.left, window.innerWidth-pw-8);
    popup.style.top=top+'px';
    popup.style.left=Math.max(8,left)+'px';
  });
}

async function setOrderStatusOT(itemId,statusKey,note){
  const item=inventory.find(i=>i.id===itemId);if(!item)return;
  const newNote=note||'';
  const newHistory=[...(item.orderHistory||[]),{status:statusKey,note:newNote,user:currentProfile.name||currentUser.email,date:new Date().toLocaleString()}];
  closeStatusPopup();
  try{
    await fsUpdateItem(itemId,{orderStatus:statusKey,orderNote:newNote,orderHistory:newHistory});
    renderOrderTracker();
    showToast('Status: '+getStatusCfg(statusKey).label,'success');
  }catch(e){showToast('Save failed: '+e.message,'error');}
}

// ════════════════════════════════════════════════════
//  HELPERS
// ════════════════════════════════════════════════════
function toggleCasField(){
  const cat=document.getElementById('f-cat').value;
  document.getElementById('casField').style.display=cat==='Chemical'?'block':'none';
}

function suggestCategory(){
  const name=document.getElementById('f-name').value.toLowerCase();
  const el=document.getElementById('catSuggest');
  const rules=[
    {p:['anti-','antibody','igg','igm','mab'],c:'Antibody'},
    {p:['polymerase','ligase','kinase','taq','enzyme'],c:'Enzyme'},
    {p:['dmem','rpmi','medium','media','fbs','serum','culture'],c:'Cell Culture'},
    {p:['pbs','buffer','tris','hepes'],c:'Buffer'},
    {p:['primer','oligo','probe'],c:'Primer'},
    {p:['plasmid','vector'],c:'Plasmid'},
    {p:['kit','elisa','assay'],c:'Kit'},
    {p:['ethanol','methanol','acid','hcl','naoh','dmso','formaldehyde','acetone'],c:'Chemical'},
    {p:['gloves','tips','tubes','tape','marker','falcon','petri','flask','beaker','pipette'],c:'General Lab Supplies'},
  ];
  if(!name){el.style.display='none';return;}
  for(const r of rules){if(r.p.some(p=>name.includes(p))){el.style.display='block';el.innerHTML=`<span class="cat-suggest" onclick="document.getElementById('f-cat').value='${r.c}';toggleCasField();this.parentElement.style.display='none'">Suggest: ${r.c}</span>`;return;}}
  el.style.display='none';
}

function showVendorSuggestions(){
  const val=document.getElementById('f-vendor').value.toLowerCase();
  const el=document.getElementById('vendorSuggest');
  if(!val||val.length<2){el.innerHTML='';return;}
  const all=[...new Set([...knownVendors,...inventory.map(i=>i.vendor).filter(Boolean)])];
  el.innerHTML=all.filter(v=>v.toLowerCase().includes(val)).slice(0,5).map(v=>`<span style="cursor:pointer;font-size:10px;color:var(--accent);font-family:var(--mono);padding:2px 6px;background:rgba(0,119,204,0.08);border:1px solid rgba(0,119,204,0.2);border-radius:4px" onclick="document.getElementById('f-vendor').value='${v}';document.getElementById('vendorSuggest').innerHTML=''">${v}</span>`).join('');
}

function exportCSV(){
  const labName=(labSettings.labName||'lab').replace(/\s+/g,'-').toLowerCase();
  const date=new Date().toISOString().split('T')[0];
  const headers=['Name','Barcode','Category','Vendor','Cat#','CAS#','Lot#','Quantity','Unit','Storage Temp','Location','Threshold','Expiry','Hazard','SDS','Order Status','Notes'];
  const rows=inventory.map(i=>[
    i.name||'', i.barcode||'', i.category||'', i.vendor||'',
    i.catNum||'', i.casNum||'', i.lotNum||'',
    i.quantity, i.unit||'', i.temp||'', i.location||'',
    i.threshold||0, i.expiry||'', i.hazard||'',
    i.sds||'', i.orderStatus||'none', i.notes||''
  ].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(','));
  const csv=[headers.join(','),...rows].join('\n');
  const a=document.createElement('a');
  a.href='data:text/csv;charset=utf-8,'+encodeURIComponent(csv);
  a.download=`${labName}-inventory-${date}.csv`;
  a.click();
  showToast('CSV exported!','success');
}

function showToast(msg,type='success'){
  const el=document.createElement('div');
  el.className='toast '+type;
  el.textContent=msg;
  document.getElementById('toastContainer').appendChild(el);
  setTimeout(()=>el.remove(),3500);
}

function showPage(page){
  const managerOnly=['analytics','users','alerts','email','labsettings'];
  if(managerOnly.includes(page)&&!isManager()){showToast('Manager access required','error');return;}
  currentPage=page;
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  document.getElementById('page-'+page).classList.add('active');
  document.getElementById('notifPanel').classList.remove('open');
  renderSidebar();
  if(page==='analytics')   renderAnalytics();
  if(page==='users')       renderUsers();
  if(page==='alerts')      renderAlertsConfig();
  if(page==='email')       renderEmailPage();
  if(page==='orders')      renderOrderTracker();
  if(page==='inventory')   renderInventory();
  if(page==='labsettings') renderLabSettings();
}

// ════════════════════════════════════════════════════
//  LAB SETTINGS & BRANDING
// ════════════════════════════════════════════════════
const ACCENT_COLORS=[
  {name:'Blue (default)', hex:'#0077cc'},
  {name:'Purple',         hex:'#7c3aed'},
  {name:'Green',          hex:'#16a34a'},
  {name:'Teal',           hex:'#0891b2'},
  {name:'Orange',         hex:'#ea580c'},
  {name:'Red',            hex:'#dc2626'},
  {name:'Pink',           hex:'#db2777'},
  {name:'Indigo',         hex:'#4f46e5'},
];

function applyLabBranding(){
  const {labName='Gao Lab', labSubtitle='Inventory System', accentColor='#0077cc'}=labSettings;
  // Accent color CSS variable
  document.documentElement.style.setProperty('--accent', accentColor);
  // Header
  const hn=document.getElementById('headerLabName');
  if(hn) hn.textContent='— '+labName;
  // Login subtitle
  const ls=document.getElementById('loginSubtitle');
  if(ls) ls.textContent=(labName+' '+labSubtitle).toUpperCase();
  // Inventory page subtitle
  const ps=document.getElementById('inventoryPageSub');
  if(ps) ps.textContent='// '+labName+' — all items';
  // Page title
  document.title='PharmDigits — '+labName;
}

async function fsSaveLabSettings(){
  const {db,doc,setDoc}=fb();
  await setDoc(doc(db,'settings','lab'),labSettings);
}

function renderLabSettings(){
  const s=labSettings;
  document.getElementById('labSettingsContent').innerHTML=`
    <div class="lab-settings-card">
      <h3>&#127981; Lab Identity</h3>
      <div class="form-grid" style="max-width:520px">
        <div class="field" style="grid-column:1/-1">
          <label>Lab Name</label>
          <input type="text" id="ls-labname" value="${s.labName||''}" placeholder="e.g. Smith Lab"
            style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-family:var(--mono);font-size:13px;color:var(--text);outline:none;width:100%">
          <div style="font-size:10px;font-family:var(--mono);color:var(--text3);margin-top:4px">Appears in the header, login screen, and page titles.</div>
        </div>
        <div class="field" style="grid-column:1/-1">
          <label>System Subtitle</label>
          <input type="text" id="ls-subtitle" value="${s.labSubtitle||''}" placeholder="e.g. Inventory System"
            style="background:var(--surface2);border:1px solid var(--border);border-radius:8px;padding:9px 12px;font-family:var(--mono);font-size:13px;color:var(--text);outline:none;width:100%">
          <div style="font-size:10px;font-family:var(--mono);color:var(--text3);margin-top:4px">Shown on the login screen below the lab name.</div>
        </div>
      </div>
      <div style="margin-top:18px">
        <div class="field">
          <label>Accent Color</label>
          <div class="color-swatches">
            ${ACCENT_COLORS.map(col=>`<div class="color-swatch ${(s.accentColor||'#0077cc')===col.hex?'active':''}"
              style="background:${col.hex}" title="${col.name}"
              onclick="previewAccent('${col.hex}')"></div>`).join('')}
          </div>
          <div class="preview-bar" id="colorPreviewBar" style="background:${s.accentColor||'#0077cc'}"></div>
          <div style="font-size:10px;font-family:var(--mono);color:var(--text3);margin-top:4px">Changes buttons, active links, and highlights throughout the app.</div>
        </div>
      </div>
      <div style="margin-top:20px;display:flex;gap:10px">
        <button class="btn primary" onclick="saveLabSettings()">Save &amp; Apply</button>
        <button class="btn" onclick="resetLabSettings()">Reset to Default</button>
      </div>
    </div>
    <div class="lab-settings-card" style="background:rgba(0,119,204,0.03);border-color:rgba(0,119,204,0.2)">
      <h3 style="color:var(--accent)">&#128161; How to use for other labs</h3>
      <p style="font-size:13px;font-family:var(--mono);color:var(--text2);line-height:1.8">
        <strong>To use this system for your lab:</strong><br>
        <strong>Step 1.</strong> Change the <em>Lab Name</em> above to your lab name and click Save.<br>
        <strong>Step 2.</strong> Go to <a href="https://console.firebase.google.com" target="_blank" style="color:var(--accent)">console.firebase.google.com</a> and create a new project.<br>
        <strong>Step 3.</strong> In the new project, enable Email/Password authentication and create a Firestore database.<br>
        <strong>Step 4.</strong> Copy the new Firebase config (apiKey, projectId etc.) into the <code style="background:var(--surface3);padding:2px 6px;border-radius:3px;font-size:12px">&lt;script type="module"&gt;</code> section at the very top of this HTML file.<br>
        <strong>Step 5.</strong> Open the file in a browser — your lab now has its own completely separate inventory, users, and data.
      </p>
    </div>`;
}

function previewAccent(hex){
  document.documentElement.style.setProperty('--accent',hex);
  document.getElementById('colorPreviewBar').style.background=hex;
  document.querySelectorAll('.color-swatch').forEach(el=>{
    el.classList.toggle('active', el.style.background===hexToRgb(hex)||el.title===ACCENT_COLORS.find(c=>c.hex===hex)?.name);
  });
}

function hexToRgb(hex){
  // Just for swatch matching — not critical
  return hex;
}

async function saveLabSettings(){
  labSettings.labName   = document.getElementById('ls-labname').value.trim()||'My Lab';
  labSettings.labSubtitle = document.getElementById('ls-subtitle').value.trim()||'Inventory System';
  labSettings.accentColor = document.documentElement.style.getPropertyValue('--accent').trim()||'#0077cc';
  try{
    await fsSaveLabSettings();
    applyLabBranding();
    renderLabSettings();
    renderSidebar();
    showToast('Lab settings saved!','success');
  }catch(e){ showToast('Save failed: '+e.message,'error'); }
}

async function resetLabSettings(){
  labSettings={labName:'Gao Lab',labSubtitle:'Inventory System',accentColor:'#0077cc'};
  try{
    await fsSaveLabSettings();
    applyLabBranding();
    renderLabSettings();
    showToast('Reset to defaults','info');
  }catch(e){ showToast('Reset failed: '+e.message,'error'); }
}

// ════════════════════════════════════════════════════
//  BOOT — wait for Firebase module, then listen for auth
// ════════════════════════════════════════════════════
function waitForFirebase(cb,attempts=0){
  if(window.__fb){ cb(); }
  else if(attempts<30){ setTimeout(()=>waitForFirebase(cb,attempts+1),200); }
  else{ alert('Firebase failed to load. Check your internet connection and Firebase config.'); }
}

// Apply default branding immediately (before login)
applyLabBranding();

waitForFirebase(()=>{
  const {auth,onAuthStateChanged}=fb();
  onAuthStateChanged(auth,user=>{
    if(user){
      initApp(user).catch(e=>{
        console.error(e);
        showToast('Error loading app: '+e.message,'error');
      });
    } else {
      // Show login
      document.getElementById('loginScreen').style.display='flex';
      document.getElementById('appHeader').style.display='none';
      document.getElementById('appBody').style.display='none';
    }
  });
});
</script>
<div id="statusOverlay"></div>
</body>
</html>
